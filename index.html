<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    :root{ --sea:#0fa8d2; }
    html,body{ height:100%; margin:0; background:var(--sea); }
    .leaflet-container{ background:var(--sea); }

    #map{ position:absolute; inset:56px 0 0 0; display:none; }
    #toolbar{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; gap:12px; align-items:center; padding:8px 12px;
      background:rgba(30,30,30,.92); color:#fff;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      z-index:1000; backdrop-filter:blur(6px);
    }
    #brand{ display:flex; align-items:center; gap:8px; }
    #brand img{ height:36px; width:auto; display:block; }
    #toolbar label{ display:flex; align-items:center; gap:6px; }
    #toolbar input[type="checkbox"]{ transform:translateY(1px); }
    #toolbar button{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; background:#fff; color:#111; font-weight:700; }
    #toolbar button:hover{ filter:brightness(.95); }
    .leaflet-tooltip{ background:#111; color:#fff; border-radius:6px; border:0; }
    .popup h3{ margin:0 8px 6px 0; font-size:16px; display:inline-block; }
    .popup p{ margin:0 0 6px; }
    .popup small{ color:#666; display:block; margin-top:6px; }
    #status{ position:absolute; inset:56px 0 0 0; display:grid; place-items:center; font:14px/1.4 system-ui; color:#333; padding:24px; text-align:center; }
    #status code{ background:#eee; padding:2px 6px; border-radius:4px; }

    #version{
      position:fixed; bottom:6px; right:10px; font:12px/1 monospace; color:rgba(255,255,255,.92);
      background:rgba(0,0,0,.6); padding:2px 6px; border-radius:4px; z-index:2000;
    }

    /* Settings button + menu */
    #settings { margin-left:auto; position:relative; }
    #settingsBtn { border:none; padding:8px 12px; border-radius:8px; background:#fff; font-weight:700; cursor:pointer; }
    #settingsMenu{
      position:absolute; right:0; top:44px; min-width:220px;
      background:#fff; color:#111; border-radius:10px; box-shadow:0 12px 24px rgba(0,0,0,.2);
      display:none; overflow:hidden; z-index:1200;
    }
    #settingsMenu button{
      display:block; width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; cursor:pointer;
    }
    #settingsMenu button:hover{ background:#f2f2f2; }

    /* Modals */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1500; }
    .modal.show{ display:grid; }
    .card{
      width:min(560px, calc(100vw - 24px)); max-height:85vh; overflow:auto;
      background:#fff; color:#111; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .card header, .card footer{ padding:12px 14px; background:#f5f5f5; }
    .card header{ border-radius:12px 12px 0 0; font-weight:700; }
    .card footer{ border-radius:0 0 12px 12px; display:flex; gap:8px; justify-content:flex-end; }
    .card main{ padding:14px; display:grid; gap:12px; }
    .row{ display:grid; gap:6px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    label span{ font-weight:600; font-size:13px; }
    input[type="text"], input[type="url"], input[type="number"], select{
      width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; font:14px system-ui;
    }
    .muted{ color:#666; font-size:12px; }
    .link-row{ display:grid; grid-template-columns:1fr 2fr; gap:8px; align-items:center; }
    .btn{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; }
    .btn.ghost{ background:#eee; }

    /* Drop Leaflet zoom buttons down so they don't overlap toolbar */
    .leaflet-control-zoom { margin-top: 70px !important; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div id="brand">
      <img src="Dynasty8-GTAV-Logo.png" alt="Dynasty 8">
      <strong>Property Map</strong>
    </div>

    <label id="addWrap" style="display:none"><input type="checkbox" id="addMode"> Add</label>
    <label id="editWrap" style="display:none"><input type="checkbox" id="editMode"> Edit</label>

    <button id="unlockBtn">Unlock</button>
    <button id="lockBtn" style="display:none">Lock</button>

    <span id="hint">Loading…</span>

    <!-- Settings (right) -->
    <div id="settings">
      <button id="settingsBtn">⚙️ Settings</button>
      <div id="settingsMenu" role="menu" aria-hidden="true">
        <button id="menuExport">Export markers</button>
        <button id="menuChangelog">Changelog</button>
        <button id="menuStats">Statistics</button>
      </div>
    </div>
  </div>

  <div id="status">Looking for <code>map.jpg</code> in this folder…</div>
  <div id="map"></div>
  <div id="version"></div>

  <!-- Add Property Modal (explicit-close only) -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="addTitle">
      <header id="addTitle">Add Property</header>
      <main>
        <div class="row">
          <label><span>Name</span>
            <input id="f-name" type="text" placeholder="e.g., Eclipse Towers Apt. 3" />
          </label>
        </div>

        <div class="grid-2">
          <label><span>Type</span>
            <select id="f-type">
              <option value="apartment" selected>Apartment</option>
              <option value="office">Office</option>
              <option value="motel">Motel</option>
              <option value="penthouse">Penthouse</option>
            </select>
          </label>
          <div class="row"><span class="muted">Type controls link fields.</span></div>
        </div>

        <div id="linksArea" class="row"></div>
        <div class="muted" id="coordsNote">Will be placed where you clicked.</div>
      </main>
      <footer>
        <button id="btnCancel" class="btn ghost">Cancel</button>
        <button id="btnSave" class="btn primary">Save</button>
      </footer>
    </div>
  </div>

  <!-- Edit Property Modal -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <header id="editTitle">Edit Property</header>
      <main id="editBody"></main>
      <footer>
        <button id="editCancel" class="btn ghost">Cancel</button>
        <button id="editSave" class="btn primary">Save</button>
      </footer>
    </div>
  </div>

  <!-- Changelog Modal -->
  <div id="changelogModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="chgTitle">
      <header id="chgTitle">Changelog</header>
      <main id="chgBody"><div style="padding:14px">Loading commits…</div></main>
      <footer><button id="chgClose" class="btn primary">Close</button></footer>
    </div>
  </div>

  <!-- Statistics Modal -->
  <div id="statsModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="statTitle">
      <header id="statTitle">Statistics</header>
      <main id="statBody"></main>
      <footer><button id="statClose" class="btn primary">Close</button></footer>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ==== Build / Version
    const VERSION = "beta 1.0.5";
    const VERSION_NOTE = "Statistics modal + Edit modal + zoom control reposition";
    document.getElementById("version").textContent = VERSION;
    console.log(`Dynasty 8 Map – ${VERSION} — ${VERSION_NOTE}`);

    // ==== Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCcfOML9FD1Q5vcoCb3NdIlFKtx3LAovBc",
      authDomain: "dynasty8-property-map.firebaseapp.com",
      projectId: "dynasty8-property-map",
      storageBucket: "dynasty8-property-map.firebasestorage.app",
      messagingSenderId: "849316207524",
      appId: "1:849316207524:web:9c921ad842fc188d027f31",
      measurementId: "G-VXG629H337"
    };

    // --- DOM refs
    const addModeEl = document.getElementById("addMode");
    const editModeEl = document.getElementById("editMode");
    const addWrap = document.getElementById("addWrap");
    const editWrap = document.getElementById("editWrap");
    const unlockBtn = document.getElementById("unlockBtn");
    const lockBtn = document.getElementById("lockBtn");
    const hintEl = document.getElementById("hint");
    const statusEl = document.getElementById("status");
    const mapEl = document.getElementById("map");

    // Settings + modals
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsMenu = document.getElementById("settingsMenu");
    const menuExport = document.getElementById("menuExport");
    const menuChangelog = document.getElementById("menuChangelog");
    const menuStats = document.getElementById("menuStats");

    const chgModal = document.getElementById("changelogModal");
    const chgBody  = document.getElementById("chgBody");
    const chgClose = document.getElementById("chgClose");

    const statModal = document.getElementById("statsModal");
    const statBody  = document.getElementById("statBody");
    const statClose = document.getElementById("statClose");

    // Add modal
    const addModal = document.getElementById("addModal");
    const fName = document.getElementById("f-name");
    const fType = document.getElementById("f-type");
    const linksArea = document.getElementById("linksArea");
    const btnCancel = document.getElementById("btnCancel");
    const btnSave = document.getElementById("btnSave");
    const coordsNote = document.getElementById("coordsNote");

    // Edit modal
    const editModal = document.getElementById("editModal");
    const editBody  = document.getElementById("editBody");
    const editCancel= document.getElementById("editCancel");
    const editSave  = document.getElementById("editSave");

    // --- Config
    const LOCAL_EDIT_PASSWORD = "D8D8D8";
    const MAP_CANDIDATES = ["map.jpg","map.jpeg","map.png"];
    const REPO_OWNER = "equestrix";
    const REPO_NAME  = "Apartment-Map";

    // --- State
    let unlocked = false;
    let map, layerGroup, currentIconSize = 32;
    let pendingLatLng = null;
    let isAddModalOpen = false;
    const markers = new Map();
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const toast = (m) => { hintEl.textContent = m; console.log(m); };

    function iconFor(entry, size = currentIconSize){
      const type = (entry.type || "apartment").toLowerCase();
      const files = {
        apartment: "house-apartment.png",
        penthouse: "house-penthouse.png",
        office:    "house-office.png",
        motel:     "house-motel.png",
      };
      return L.icon({
        iconUrl: files[type] || files.apartment,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        tooltipAnchor: [0, -size/2]
      });
    }

    function entryLinks(entry){
      if (Array.isArray(entry.links) && entry.links.length) return entry.links;
      const arr = [];
      if (entry.shabby) arr.push({label:"Shabby Apartment", url:entry.shabby});
      if (entry.nice)   arr.push({label:"Nice Apartment",   url:entry.nice});
      return arr;
    }

    function renderLinksHTML(entry){
      const t = (entry.type || "apartment").toLowerCase();
      const links = entryLinks(entry);
      if (t === "apartment") {
        const shabby = links.find(l => /shabby/i.test(l.label));
        const nice   = links.find(l => /nice/i.test(l.label));
        return `${shabby?`<p><a href="${shabby.url}" target="_blank" rel="noopener">Shabby Apartment</a></p>`:""}${nice?`<p><a href="${nice.url}" target="_blank" rel="noopener">Nice Apartment</a></p>`:""}`;
      }
      if (t === "office") {
        const link = links[0]; return link ? `<p><a href="${link.url}" target="_blank" rel="noopener">Office</a></p>` : "";
      }
      if (t === "motel") {
        const link = links[0];
        const note = `<div style="color:#d60000;font-weight:700;margin-top:6px">Don’t use this link in your listing, you need a door photo!</div>`;
        return (link ? `<p><a href="${link.url}" target="_blank" rel="noopener">Album</a></p>` : "") + note;
      }
      if (t === "penthouse") {
        return links.map(l => `<p><a href="${l.url}" target="_blank" rel="noopener">${l.label || "Album"}</a></p>`).join("");
      }
      return links.map(l => `<p><a href="${l.url}" target="_blank" rel="noopener">${l.label || "Link"}</a></p>`).join("");
    }

    function setLockedUI(lock){
      unlocked = !lock;
      unlockBtn.style.display = lock ? "" : "none";
      lockBtn.style.display   = lock ? "none" : "";
      addWrap.style.display   = lock ? "none" : "";
      editWrap.style.display  = lock ? "none" : "";
      if (lock) editModeEl.checked = false;
      applyEditMode();
      toast(lock ? "Locked (view-only)" : "Edit unlocked");
    }

    function setMarkerPopup(entry){
      const html = `
        <div class="popup">
          <div style="display:flex;align-items:center;gap:8px;">
            <h3 style="margin:0">${entry.name || "Property"}</h3>
            <small>${(entry.type || "apartment").toUpperCase()}</small>
            ${ (unlocked && editModeEl.checked)
              ? '<button class="btn" data-action="edit" style="margin-left:8px;padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:#eee">Edit</button>\
                 <button class="btn" data-action="delete" style="padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:#eee">Delete</button>'
              : '' }
          </div>
          ${renderLinksHTML(entry)}
          <small>Coords: x=${entry.x.toFixed(1)}, y=${entry.y.toFixed(1)}</small>
        </div>`;
      entry._marker.bindPopup(html);

      entry._marker.off('popupopen').on('popupopen', (e) => {
        if (!(unlocked && editModeEl.checked)) return;
        const el = e.popup.getElement(); if (!el) return;
        const editBtn = el.querySelector('[data-action="edit"]');
        const delBtn  = el.querySelector('[data-action="delete"]');

        if (editBtn) editBtn.addEventListener('click', () => openEditModal(entry));
        if (delBtn) delBtn.addEventListener('click', async () => {
          if (!confirm("Delete this marker?")) return;
          await deleteDoc(doc(db, "markers", entry.id));
        });
      });
    }

    function createOrUpdateMarker(entry){
      let m = markers.get(entry.id);
      if (!m) {
        m = { ...entry };
        m._marker = L.marker([m.y, m.x], {
          draggable: !!(unlocked && editModeEl.checked),
          autoPan: true,
          icon: iconFor(entry)
        })
        .addTo(layerGroup)
        .bindTooltip(m.name || "Property", {direction: "top", offset: [0,-10]});
        markers.set(entry.id, m);
        setMarkerPopup(m);

        m._marker.on('dragend', async (e) => {
          const pos = e.target.getLatLng();
          await updateDoc(doc(db, "markers", m.id), { y: pos.lat, x: pos.lng, updatedAt: serverTimestamp() });
        });
      } else {
        m.name = entry.name; m.x = entry.x; m.y = entry.y;
        m.type = entry.type; m.links = entry.links;
        m.shabby = entry.shabby; m.nice = entry.nice;
        m._marker.setLatLng([m.y, m.x]);
        m._marker.setIcon(iconFor(entry));
        m._marker.setTooltipContent(m.name || "Property");
        setMarkerPopup(m);
      }
    }

    function removeMarker(id){
      const m = markers.get(id);
      if (m && m._marker) layerGroup.removeLayer(m._marker);
      markers.delete(id);
    }

    function applyEditMode(){
      const canEdit = unlocked && editModeEl.checked;
      markers.forEach(m => {
        if (m._marker) {
          if (canEdit) m._marker.dragging.enable(); else m._marker.dragging.disable();
          setMarkerPopup(m);
        }
      });
      hintEl.textContent = canEdit ? "Edit mode ON" : (unlocked ? "Edit mode OFF" : "Locked (view-only)");
    }

    // ===== Add Modal logic (explicit close only) =====
    function buildLinksFields(type){
      linksArea.innerHTML = "";
      if (type === "apartment") {
        linksArea.innerHTML = `
          <div class="grid-2">
            <label><span>Shabby Apartment URL</span><input id="f-shabby" type="url" placeholder="https://imgur.com/a/…" /></label>
            <label><span>Nice Apartment URL</span><input id="f-nice" type="url" placeholder="https://imgur.com/a/…" /></label>
          </div>`;
      } else if (type === "office") {
        linksArea.innerHTML = `<label><span>Office URL</span><input id="f-office" type="url" placeholder="https://imgur.com/a/…" /></label>`;
      } else if (type === "motel") {
        linksArea.innerHTML = `<label><span>Motel Album URL</span><input id="f-motel" type="url" placeholder="https://imgur.com/a/…" /></label>`;
      } else if (type === "penthouse") {
        const wrap = document.createElement("div");
        wrap.className = "row";
        wrap.innerHTML = `
          <div class="grid-2">
            <label><span>Number of links (1–8)</span><input id="f-count" type="number" value="1" min="1" max="8"/></label>
            <div class="row"><span class="muted">Each link can have a custom label.</span></div>
          </div>
          <div id="ph-rows" class="row"></div>`;
        linksArea.appendChild(wrap);

        const phRows = wrap.querySelector("#ph-rows");
        const fCount = wrap.querySelector("#f-count");

        function renderRows(){
          const n = Math.max(1, Math.min(8, parseInt(fCount.value || "1", 10)));
          phRows.innerHTML = "";
          for (let i=0;i<n;i++){
            const row = document.createElement("div");
            row.className = "link-row";
            row.innerHTML = `
              <input type="text" class="ph-label" placeholder="Album ${i+1}" />
              <input type="url"  class="ph-url"   placeholder="https://imgur.com/a/…" />`;
            phRows.appendChild(row);
          }
        }
        fCount.addEventListener("input", renderRows);
        renderRows();
      }
    }

    function openAddModal(latlng){
      pendingLatLng = latlng;
      isAddModalOpen = true;
      coordsNote.textContent = `Placing at x=${latlng.lng.toFixed(1)}, y=${latlng.lat.toFixed(1)}`;
      fName.value = "";
      fType.value = "apartment";
      buildLinksFields("apartment");
      addModal.classList.add("show");
    }
    function closeAddModal(){
      addModal.classList.remove("show");
      pendingLatLng = null;
      isAddModalOpen = false;
    }

    btnCancel.addEventListener("click", closeAddModal);
    fType.addEventListener("change", (e)=> buildLinksFields(e.target.value));
    btnSave.addEventListener("click", async ()=>{
      if (!pendingLatLng) return closeAddModal();
      const name = (fName.value || "").trim();
      if (!name) { alert("Please enter a name."); return; }
      const type = fType.value;
      const {lat, lng} = pendingLatLng;

      let links = [];
      let shabby = "", nice = "";
      if (type === "apartment"){
        shabby = (document.getElementById("f-shabby").value || "").trim();
        nice   = (document.getElementById("f-nice").value   || "").trim();
        if (shabby) links.push({label:"Shabby Apartment", url:shabby});
        if (nice)   links.push({label:"Nice Apartment",   url:nice});
      } else if (type === "office"){
        const u = (document.getElementById("f-office").value || "").trim();
        if (u) links.push({label:"Office", url:u});
      } else if (type === "motel"){
        const u = (document.getElementById("f-motel").value || "").trim();
        if (u) links.push({label:"Album", url:u});
      } else if (type === "penthouse"){
        const rows = linksArea.querySelectorAll(".link-row");
        rows.forEach((row, i)=>{
          const label = (row.querySelector(".ph-label").value || `Album ${i+1}`).trim();
          const url   = (row.querySelector(".ph-url").value   || "").trim();
          if (url) links.push({label, url});
        });
      }

      await addDoc(collection(db, "markers"), {
        name, type, links, x: lng, y: lat,
        shabby: type==="apartment" ? (shabby || "") : "",
        nice:   type==="apartment" ? (nice   || "") : "",
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      });

      closeAddModal();
      toast("Property added.");
    });

    // ===== Edit modal =====
    let editingEntry = null;

    function buildEditFields(type, entry){
      editBody.innerHTML = "";
      const nameRow = document.createElement("div");
      nameRow.className = "row";
      nameRow.innerHTML = `<label><span>Name</span><input id="e-name" type="text" value="${entry.name||""}"></label>`;
      editBody.appendChild(nameRow);

      const typeRow = document.createElement("div");
      typeRow.className = "row";
      typeRow.innerHTML = `
        <label><span>Type</span>
          <select id="e-type">
            <option value="apartment" ${entry.type==="apartment"?"selected":""}>Apartment</option>
            <option value="office" ${entry.type==="office"?"selected":""}>Office</option>
            <option value="motel" ${entry.type==="motel"?"selected":""}>Motel</option>
            <option value="penthouse" ${entry.type==="penthouse"?"selected":""}>Penthouse</option>
          </select>
        </label>`;
      editBody.appendChild(typeRow);

      const linksWrap = document.createElement("div");
      linksWrap.id = "e-links";
      linksWrap.className = "row";
      editBody.appendChild(linksWrap);

      // render link fields by type
      const links = Array.isArray(entry.links) ? entry.links.slice() : entryLinks(entry).slice();

      if (type === "apartment"){
        const shabby = links.find(l=>/shabby/i.test(l.label))?.url || entry.shabby || "";
        const nice   = links.find(l=>/nice/i.test(l.label))?.url   || entry.nice   || "";
        linksWrap.innerHTML = `
          <div class="grid-2">
            <label><span>Shabby Apartment URL</span><input id="e-shabby" type="url" value="${shabby}"/></label>
            <label><span>Nice Apartment URL</span><input id="e-nice" type="url" value="${nice}"/></label>
          </div>`;
      } else if (type === "office") {
        const url = links[0]?.url || "";
        linksWrap.innerHTML = `<label><span>Office URL</span><input id="e-office" type="url" value="${url}"/></label>`;
      } else if (type === "motel") {
        const url = links[0]?.url || "";
        linksWrap.innerHTML = `<label><span>Motel Album URL</span><input id="e-motel" type="url" value="${url}"/></label>`;
      } else if (type === "penthouse") {
        const wrap = document.createElement("div");
        wrap.className = "row";
        const count = Math.max(1, Math.min(8, links.length || 1));
        wrap.innerHTML = `
          <div class="grid-2">
            <label><span>Number of links (1–8)</span><input id="e-count" type="number" value="${count}" min="1" max="8"/></label>
            <div class="row"><span class="muted">Each link can have a custom label.</span></div>
          </div>
          <div id="e-phrows" class="row"></div>`;
        linksWrap.appendChild(wrap);

        const rows = wrap.querySelector("#e-phrows");
        const eCount = wrap.querySelector("#e-count");

        function draw(n){
          rows.innerHTML = "";
          for(let i=0;i<n;i++){
            const l = links[i] || {};
            const row = document.createElement("div");
            row.className = "link-row";
            row.innerHTML = `
              <input type="text" class="e-label" value="${l.label || `Album ${i+1}`}">
              <input type="url"  class="e-url"   value="${l.url   || ""}">`;
            rows.appendChild(row);
          }
        }
        draw(count);
        eCount.addEventListener("input", ()=> draw(Math.max(1, Math.min(8, parseInt(eCount.value||"1",10)))));
      }
    }

    function openEditModal(entry){
      editingEntry = { ...entry }; // shallow copy
      buildEditFields(entry.type || "apartment", editingEntry);
      editModal.classList.add("show");

      // handle type change
      editBody.addEventListener("change", onTypeChange, { once:true });
      function onTypeChange(e){
        if (e.target && e.target.id === "e-type"){
          buildEditFields(e.target.value, editingEntry);
          editBody.addEventListener("change", onTypeChange, { once:true });
        }
      }
    }

    editCancel.addEventListener("click", ()=>{ editModal.classList.remove("show"); editingEntry=null; });

    editSave.addEventListener("click", async ()=>{
      if (!editingEntry) return;
      const name = (document.getElementById("e-name").value || "").trim();
      const type = document.getElementById("e-type").value;

      let links = [];
      let shabby = "", nice = "";
      if (type === "apartment"){
        shabby = (document.getElementById("e-shabby").value || "").trim();
        nice   = (document.getElementById("e-nice").value   || "").trim();
        if (shabby) links.push({label:"Shabby Apartment", url:shabby});
        if (nice)   links.push({label:"Nice Apartment",   url:nice});
      } else if (type === "office"){
        const u = (document.getElementById("e-office").value || "").trim();
        if (u) links.push({label:"Office", url:u});
      } else if (type === "motel"){
        const u = (document.getElementById("e-motel").value || "").trim();
        if (u) links.push({label:"Album", url:u});
      } else if (type === "penthouse"){
        const rows = editBody.querySelectorAll("#e-phrows .link-row");
        rows.forEach((row,i)=>{
          const label = (row.querySelector(".e-label").value || `Album ${i+1}`).trim();
          const url   = (row.querySelector(".e-url").value   || "").trim();
          if (url) links.push({label, url});
        });
      }

      await updateDoc(doc(db,"markers",editingEntry.id),{
        name, type, links,
        shabby: type==="apartment" ? (shabby || "") : "",
        nice:   type==="apartment" ? (nice   || "") : "",
        updatedAt: serverTimestamp()
      });
      editModal.classList.remove("show");
      editingEntry=null;
    });

    // ===== Statistics =====
    function renderStats(){
      const counts = { total: 0, apartment: 0, penthouse: 0, office: 0, motel: 0 };
      markers.forEach(m => {
        counts.total++;
        const t = (m.type || "apartment").toLowerCase();
        if (counts[t] !== undefined) counts[t]++;
      });
      statBody.innerHTML = `
        <div style="padding:14px">
          <p><strong>Total properties:</strong> ${counts.total}</p>
          <p>Apartments: ${counts.apartment}</p>
          <p>Penthouses: ${counts.penthouse}</p>
          <p>Offices: ${counts.office}</p>
          <p>Motels: ${counts.motel}</p>
        </div>`;
    }

    // ===== Map + data =====
    function init(imageUrl, w, h){
      statusEl.style.display = "none";
      mapEl.style.display = "block";

      const bounds = [[0,0],[h,w]];
      map = L.map("map", { crs: L.CRS.Simple, minZoom: -2, maxZoom: 5, zoomControl: true, attributionControl: false });
      L.imageOverlay(imageUrl, bounds).addTo(map);
      map.fitBounds(bounds);

      layerGroup = L.layerGroup().addTo(map);

      map.on("zoomend", () => {
        const z = map.getZoom();
        currentIconSize = Math.max(16, Math.min(48, z * 4));
        markers.forEach(m => { if (m._marker) m._marker.setIcon(iconFor(m)); });
      });

      map.on("click", (e) => {
        if (isAddModalOpen) return; // keep add modal open until Save/Cancel
        if (!(unlocked && addModeEl.checked)) return;
        openAddModal(e.latlng);
      });

      setLockedUI(true);

      const colRef = collection(db, "markers");
      onSnapshot(colRef, (snap) => {
        const seen = new Set();
        snap.forEach(d => {
          const v = d.data();
          const entry = {
            id: d.id,
            name: v.name || "Property",
            x: v.x, y: v.y,
            type: v.type || "apartment",
            links: Array.isArray(v.links) ? v.links : [],
            shabby: v.shabby || "",
            nice: v.nice || ""
          };
          createOrUpdateMarker(entry);
          seen.add(d.id);
        });
        [...markers.keys()].forEach(id => { if (!seen.has(id)) removeMarker(id); });
        map.fire("zoomend");
        // Update stats live if open
        if (statModal.classList.contains("show")) renderStats();
        hintEl.textContent = `Loaded ${markers.size} properties`;
      });

      // Unlock/Lock
      unlockBtn.addEventListener("click", async () => {
        const pass = prompt("Password:");
        if (pass !== LOCAL_EDIT_PASSWORD) return alert("Wrong password.");
        await signInAnonymously(auth);
        setLockedUI(false);
      });
      lockBtn.addEventListener("click", async () => {
        await signOut(auth);
        setLockedUI(true);
      });

      editModeEl.addEventListener("change", applyEditMode);
    }

    // ===== Image loader
    function tryLoadImage(i=0){
      if(i >= MAP_CANDIDATES.length){
        statusEl.innerHTML = 'Could not find a map image. Put it next to <code>index.html</code> and name it <code>map.jpg</code>, <code>map.jpeg</code>, or <code>map.png</code>.';
        hintEl.textContent = "Map image not found.";
        console.warn("[map] no candidates worked");
        return;
      }
      const src = MAP_CANDIDATES[i] + "?v=" + Date.now();
      console.log("[map] trying:", src);
      const img = new Image();
      img.onload = () => { console.log("[map] loaded:", src, img.naturalWidth+"x"+img.naturalHeight); init(src, img.naturalWidth, img.naturalHeight); };
      img.onerror = () => { console.warn("[map] failed:", src); tryLoadImage(i+1); };
      img.src = src;
    }

    // ==== Settings menu hooks ====
    settingsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const open = settingsMenu.style.display === "block";
      settingsMenu.style.display = open ? "none" : "block";
    });
    document.addEventListener("click", () => { settingsMenu.style.display = "none"; });

    // Export (moved into Settings)
    menuExport.addEventListener("click", () => {
      settingsMenu.style.display = "none";
      const clean = [...markers.values()].map(({name,x,y,type,links,shabby,nice}) => ({name,x,y,type,links,shabby,nice}));
      const blob = new Blob([JSON.stringify(clean, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement("a"), { href: url, download: "markers.json" });
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });

    // Statistics
    menuStats.addEventListener("click", () => { settingsMenu.style.display = "none"; renderStats(); statModal.classList.add("show"); });
    statClose.addEventListener("click", () => statModal.classList.remove("show"));

    // Changelog
    menuChangelog.addEventListener("click", () => { settingsMenu.style.display = "none"; openChangelog(); });
    chgClose.addEventListener("click", () => chgModal.classList.remove("show"));

    async function openChangelog(){
      chgBody.innerHTML = '<div style="padding:14px">Loading commits…</div>';
      chgModal.classList.add("show");
      const cacheKey = "chg_"+REPO_OWNER+"_"+REPO_NAME;
      const cached = sessionStorage.getItem(cacheKey);
      if (cached) { chgBody.innerHTML = cached; return; }
      try{
        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/commits?per_page=20`;
        const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" }});
        if (!res.ok) throw new Error("GitHub API " + res.status);
        const commits = await res.json();
        const html = commits.map(c=>{
          const msg = (c.commit?.message || "").trim();
          const [title, ...rest] = msg.split(/\r?\n/);
          const body = rest.join("\n").trim();
          const date = new Date(c.commit?.author?.date || c.commit?.committer?.date || Date.now());
          const when = date.toLocaleString();
          return `
            <div class="commit" style="padding:12px 14px; border-bottom:1px solid #eee">
              <h4 style="margin:0 0 6px; font-size:14px">${escapeHtml(title || "Commit")}</h4>
              ${body ? `<div class="muted" style="white-space:pre-wrap">${escapeHtml(body)}</div>` : ""}
              <small class="muted">${escapeHtml(c.commit?.author?.name || c.author?.login || "Unknown")} — ${when}</small>
            </div>`;
        }).join("");
        chgBody.innerHTML = html || '<div style="padding:14px">No recent commits.</div>';
        sessionStorage.setItem(cacheKey, chgBody.innerHTML);
      }catch(err){
        chgBody.innerHTML = `<div style="padding:14px;color:#b00020">Failed to load commits: ${escapeHtml(err.message)}</div>`;
      }
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Boot
    tryLoadImage();
  </script>

  <!-- Safe fallback loader (keeps page usable if module fails) -->
  <script>
    (function(){
      if (typeof window.tryLoadImage === "function") return;
      const MAP_CANDIDATES=["map.jpg","map.jpeg","map.png"];
      function fallbackInit(imageUrl,w,h){
        const mEl=document.getElementById("map"), sEl=document.getElementById("status");
        if (sEl) sEl.style.display="none"; if (mEl) mEl.style.display="block";
        if (!window.L) return console.warn("[fallback] Leaflet missing");
        const bounds=[[0,0],[h,w]];
        const m=L.map("map",{crs:L.CRS.Simple,minZoom:-2,maxZoom:5,zoomControl:true,attributionControl:false});
        L.imageOverlay(imageUrl,bounds).addTo(m); m.fitBounds(bounds);
        console.log("[fallback] map shown with", imageUrl);
      }
      function load(i=0){
        if(i>=MAP_CANDIDATES.length){const s=document.getElementById("status"); if(s) s.innerHTML='Could not find map image.'; return;}
        const src=MAP_CANDIDATES[i]+"?v="+Date.now(); const im=new Image();
        console.log("[fallback] trying", src);
        im.onload=()=>{ if(typeof window.init==="function") window.init(src,im.naturalWidth,im.naturalHeight); else fallbackInit(src,im.naturalWidth,im.naturalHeight); };
        im.onerror=()=>load(i+1); im.src=src;
      }
      window.addEventListener("load", load);
    })();
  </script>
</body>
</html>
