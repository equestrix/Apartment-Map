<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{
      --main:#93c47d;       /* header / brand */
      --secondary:#b6d7a8;  /* body */
      --accent:#d9ead3;     /* cards / accents */
      --sea:#0fa8d2;        /* page/map bg */
      --ink:#111;
      --muted:#666;
      --paper:#fff;
    }

    html,body{ height:100%; margin:0; background:var(--sea); }
    .leaflet-container{ background:var(--sea); }

    /* Layout */
    #map{ position:absolute; inset:56px 0 0 0; display:none; }
    #toolbar{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; gap:12px; align-items:center; padding:8px 12px;
      background:var(--main); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    #brand{ display:flex; align-items:center; gap:8px; }
    #brand img{ height:36px; width:auto; display:block; }
    #toolbar label{ display:flex; align-items:center; gap:6px; }
    #toolbar input[type="checkbox"]{ transform:translateY(1px); }
    #toolbar button{
      border:none; padding:8px 12px; border-radius:8px; cursor:pointer;
      background:#fff; color:#111; font-weight:700;
    }
    /* Hover fix: keep text visible */
    #toolbar button:hover{ filter:brightness(.97); color:#111; }

    /* Status bottom-left */
    #status{
      position:fixed; bottom:8px; left:10px;
      font:13px/1.3 system-ui; color:#111;
      background:rgba(255,255,255,.9);
      padding:4px 8px; border-radius:6px; z-index:1200;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }

    /* Version bottom-right */
    #version{
      position:fixed; bottom:8px; right:10px; font:12px/1 monospace;
      color:rgba(255,255,255,.92); background:rgba(0,0,0,.6);
      padding:2px 6px; border-radius:4px; z-index:1200;
    }

    /* Settings button + menu */
    #settings{ margin-left:auto; position:relative; }
    #settingsBtn{ background:#fff; color:#111; }
    #settingsMenu{
      position:absolute; right:0; top:44px; min-width:220px;
      background:#fff; color:#111; border-radius:10px;
      box-shadow:0 12px 24px rgba(0,0,0,.2);
      display:none; overflow:hidden; z-index:1400;
    }
    #settingsMenu button{
      display:block; width:100%; text-align:left; padding:10px 12px;
      border:0; background:transparent; cursor:pointer; color:#111;
    }
    #settingsMenu button:hover{ background:#f2f2f2; color:#111; } /* hover fix */

    /* Modals (styled with your palette) */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1500; }
    .modal.show{ display:grid; }
    .card{
      width:min(560px, calc(100vw - 24px)); max-height:85vh; overflow:auto;
      background:var(--secondary); color:var(--ink); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .card header{ padding:12px 14px; background:var(--main); border-radius:12px 12px 0 0; font-weight:700; position:relative; }
    .card main{ padding:14px; display:grid; gap:12px; background:var(--accent); }
    .card footer{ padding:12px 14px; background:var(--secondary); border-radius:0 0 12px 12px; display:flex; gap:8px; justify-content:flex-end; }
    .modal .btn{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; }
    .btn.ghost{ background:#eee; color:#111; }
    .row{ display:grid; gap:6px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    label span{ font-weight:600; font-size:13px; }
    input[type="text"], input[type="url"], input[type="number"], select{
      width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; font:14px system-ui;
      background:#fff; color:#111;
    }
    .muted{ color:#333; font-size:12px; }
    .link-row{ display:grid; grid-template-columns:1fr 2fr; gap:8px; align-items:center; }

    /* Changelog X button (top-right) */
    .modal .close-x{
      position:absolute; right:10px; top:8px; width:28px; height:28px; border-radius:6px;
      background:#fff; color:#111; border:0; cursor:pointer; font-weight:700;
    }
    .modal .close-x:hover{ filter:brightness(.95); }

    /* Leaflet popup styling with palette */
    .leaflet-popup-content-wrapper{
      background:var(--secondary);
      border:2px solid var(--main);
      border-radius:10px;
    }
    .leaflet-popup-tip{ background:var(--secondary); }
    .popup h3{
      margin:0 0 6px 0; font-size:16px;
      color:#111; background:var(--main); padding:4px 6px; border-radius:6px; display:inline-block;
    }
    .popup p{ margin:0 0 6px; }
    .popup small{ color:#333; display:block; margin-top:6px; }
    .popup a{ color:#003366; font-weight:600; }

    /* Move Leaflet zoom controls to bottom-left */
    .leaflet-control-zoom{
      position:absolute !important; left:10px !important; bottom:48px !important;
      top:auto !important; margin:0 !important;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <div id="brand">
      <img src="Dynasty8-GTAV-Logo.png" alt="Dynasty 8">
      <strong>Property Map</strong>
    </div>

    <!-- Hidden until unlocked -->
    <label id="addWrap" style="display:none"><input type="checkbox" id="addMode"> Add</label>
    <label id="editWrap" style="display:none"><input type="checkbox" id="editMode"> Edit</label>

    <button id="unlockBtn">Unlock</button>
    <button id="lockBtn" style="display:none">Lock</button>

    <span id="hint">Loading…</span>

    <!-- Settings (right) -->
    <div id="settings">
      <button id="settingsBtn">⚙️ Settings</button>
      <div id="settingsMenu" role="menu" aria-hidden="true">
        <button id="menuExport">Export markers</button>
        <button id="menuChangelog">Changelog</button>
        <button id="menuStats">Statistics</button>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Bottom badges -->
  <div id="status">Loading map…</div>
  <div id="version"></div>

  <!-- Add Property Modal -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="addTitle">
      <header id="addTitle">Add Property</header>
      <main>
        <div class="row">
          <label><span>Name</span>
            <input id="f-name" type="text" placeholder="e.g., Eclipse Towers Apt. 3">
          </label>
        </div>

        <div class="grid-2">
          <label><span>Type</span>
            <select id="f-type">
              <option value="apartment" selected>Apartment</option>
              <option value="office">Office</option>
              <option value="motel">Motel</option>
              <option value="penthouse">Penthouse</option>
            </select>
          </label>
          <div class="row"><span class="muted">Type controls link fields.</span></div>
        </div>

        <div id="linksArea" class="row"></div>
        <div class="muted" id="coordsNote">Will be placed where you clicked.</div>
      </main>
      <footer>
        <button id="btnCancel" class="btn ghost">Cancel</button>
        <button id="btnSave" class="btn primary">Save</button>
      </footer>
    </div>
  </div>

  <!-- Edit Property Modal -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <header id="editTitle">Edit Property</header>
      <main id="editBody"></main>
      <footer>
        <button id="editCancel" class="btn ghost">Cancel</button>
        <button id="editSave" class="btn primary">Save</button>
      </footer>
    </div>
  </div>

  <!-- Changelog Modal -->
  <div id="changelogModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="chgTitle">
      <header id="chgTitle">Changelog
        <button id="chgCloseX" class="close-x" aria-label="Close">×</button>
      </header>
      <main id="chgBody"><div style="padding:14px">Loading commits…</div></main>
      <footer><button id="chgClose" class="btn primary">Close</button></footer>
    </div>
  </div>

  <!-- Statistics Modal -->
  <div id="statsModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="statTitle">
      <header id="statTitle">Statistics</header>
      <main id="statBody"></main>
      <footer><button id="statClose" class="btn primary">Close</button></footer>
    </div>
  </div>

  <!-- Leaflet core -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Build / Version =====
    const VERSION = "beta 1.0.6";
    const VERSION_NOTE = "Type clustering, stylized UI, bottom-left status/zoom, hover fix, changelog X";
    document.getElementById("version").textContent = VERSION;
    console.log("Dynasty 8 Map — " + VERSION + " — " + VERSION_NOTE);

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCcfOML9FD1Q5vcoCb3NdIlFKtx3LAovBc",
      authDomain: "dynasty8-property-map.firebaseapp.com",
      projectId: "dynasty8-property-map",
      storageBucket: "dynasty8-property-map.firebasestorage.app",
      messagingSenderId: "849316207524",
      appId: "1:849316207524:web:9c921ad842fc188d027f31",
      measurementId: "G-VXG629H337"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== DOM refs =====
    const addModeEl  = document.getElementById("addMode");
    const editModeEl = document.getElementById("editMode");
    const addWrap    = document.getElementById("addWrap");
    const editWrap   = document.getElementById("editWrap");
    const unlockBtn  = document.getElementById("unlockBtn");
    const lockBtn    = document.getElementById("lockBtn");
    const hintEl     = document.getElementById("hint");
    const statusEl   = document.getElementById("status");
    const mapEl      = document.getElementById("map");

    // Settings + menus
    const settingsBtn   = document.getElementById("settingsBtn");
    const settingsMenu  = document.getElementById("settingsMenu");
    const menuExport    = document.getElementById("menuExport");
    const menuChangelog = document.getElementById("menuChangelog");
    const menuStats     = document.getElementById("menuStats");

    // Changelog modal refs
    const chgModal  = document.getElementById("changelogModal");
    const chgBody   = document.getElementById("chgBody");
    const chgClose  = document.getElementById("chgClose");
    const chgCloseX = document.getElementById("chgCloseX");

    // Stats modal refs
    const statModal = document.getElementById("statsModal");
    const statBody  = document.getElementById("statBody");
    const statClose = document.getElementById("statClose");

    // Add modal refs
    const addModal   = document.getElementById("addModal");
    const fName      = document.getElementById("f-name");
    const fType      = document.getElementById("f-type");
    const linksArea  = document.getElementById("linksArea");
    const btnCancel  = document.getElementById("btnCancel");
    const btnSave    = document.getElementById("btnSave");
    const coordsNote = document.getElementById("coordsNote");

    // Edit modal refs
    const editModal  = document.getElementById("editModal");
    const editBody   = document.getElementById("editBody");
    const editCancel = document.getElementById("editCancel");
    const editSave   = document.getElementById("editSave");
    let editingEntry = null;

    // ===== Config =====
    const LOCAL_EDIT_PASSWORD = "D8D8D8";
    const MAP_CANDIDATES = ["map.jpg","map.jpeg","map.png"];
    const REPO_OWNER = "equestrix";
    const REPO_NAME  = "Apartment-Map";

    // ===== State =====
    let unlocked = false;
    let map, currentIconSize = 32;

    // Marker storage + clusters (by type)
    const markers = new Map(); // id -> {data, _marker}
    const clusters = {
      apartment: L.markerClusterGroup({ spiderfyOnMaxZoom:true, showCoverageOnHover:false, disableClusteringAtZoom: 4 }),
      penthouse: L.markerClusterGroup({ spiderfyOnMaxZoom:true, showCoverageOnHover:false, disableClusteringAtZoom: 4 }),
      office:    L.markerClusterGroup({ spiderfyOnMaxZoom:true, showCoverageOnHover:false, disableClusteringAtZoom: 4 }),
      motel:     L.markerClusterGroup({ spiderfyOnMaxZoom:true, showCoverageOnHover:false, disableClusteringAtZoom: 4 })
    };

    function toast(m){ hintEl.textContent = m; }

    function iconFor(entry, size){
      const t = (entry.type || "apartment").toLowerCase();
      const files = {
        apartment: "house-apartment.png", /* white */
        penthouse: "house-penthouse.png", /* green */
        office:    "house-office.png",    /* blue */
        motel:     "house-motel.png"      /* red */
      };
      const s = size || currentIconSize;
      return L.icon({
        iconUrl: files[t] || files.apartment,
        iconSize: [s, s],
        iconAnchor: [s/2, s/2],
        tooltipAnchor: [0, -s/2]
      });
    }

    function entryLinks(entry){
      if (entry && entry.links && entry.links.length) return entry.links;
      const arr = [];
      if (entry && entry.shabby) arr.push({ label: "Shabby Apartment", url: entry.shabby });
      if (entry && entry.nice)   arr.push({ label: "Nice Apartment",   url: entry.nice });
      return arr;
    }

    function renderLinksHTML(entry){
      const t = (entry.type || "apartment").toLowerCase();
      const links = entryLinks(entry);
      if (t === "apartment") {
        var shabby = null, nice = null;
        for (var i=0;i<links.length;i++){
          if (!shabby && links[i].label && /shabby/i.test(links[i].label)) shabby = links[i];
          if (!nice && links[i].label && /nice/i.test(links[i].label))     nice   = links[i];
        }
        return (shabby ? '<p><a href="'+shabby.url+'" target="_blank" rel="noopener">Shabby Apartment</a></p>' : '') +
               (nice   ? '<p><a href="'+nice.url+'"   target="_blank" rel="noopener">Nice Apartment</a></p>'   : '');
      }
      if (t === "office") {
        var link = links[0];
        return link ? '<p><a href="'+link.url+'" target="_blank" rel="noopener">Office</a></p>' : '';
      }
      if (t === "motel") {
        var mlink = links[0];
        var note = '<div style="color:#d60000;font-weight:700;margin-top:6px">Don’t use this link in your listing, you need a door photo!</div>';
        return (mlink ? '<p><a href="'+mlink.url+'" target="_blank" rel="noopener">Album</a></p>' : '') + note;
      }
      if (t === "penthouse") {
        var html = "";
        for (var j=0;j<links.length;j++){
          var Lk = links[j];
          html += '<p><a href="'+(Lk.url||'')+'" target="_blank" rel="noopener">'+(Lk.label||"Album")+'</a></p>';
        }
        return html;
      }
      // default
      var out = "";
      for (var k=0;k<links.length;k++){
        var lk = links[k];
        out += '<p><a href="'+(lk.url||'')+'" target="_blank" rel="noopener">'+(lk.label||"Link")+'</a></p>';
      }
      return out;
    }

    function applyEditMode(){
      var canEdit = unlocked && editModeEl.checked;
      markers.forEach(function(m){
        if (m._marker) {
          if (canEdit && m._marker.dragging) m._marker.dragging.enable();
          else if (m._marker.dragging) m._marker.dragging.disable();
          setMarkerPopup(m);
        }
      });
      toast(canEdit ? "Edit mode ON" : (unlocked ? "Edit mode OFF" : "Locked (view-only)"));
    }

    function setLockedUI(lock){
      unlocked = !lock;
      document.getElementById("unlockBtn").style.display = lock ? "" : "none";
      document.getElementById("lockBtn").style.display   = lock ? "none" : "";
      addWrap.style.display   = lock ? "none" : "";
      editWrap.style.display  = lock ? "none" : "";
      if (lock) editModeEl.checked = false;
      applyEditMode();
      toast(lock ? "Locked (view-only)" : "Edit unlocked");
    }

    function setMarkerPopup(entry){
      var html =
        '<div class="popup">' +
          '<h3>'+(entry.name || "Property")+'</h3>' +
          '<p><strong>Type:</strong> '+(entry.type || "apartment")+'</p>' +
          renderLinksHTML(entry) +
          '<small>Coords: x='+entry.x.toFixed(1)+', y='+entry.y.toFixed(1)+'</small>' +
          ((unlocked && editModeEl.checked) ?
            '<div style="margin-top:6px;display:flex;gap:8px">' +
              '<button class="btn" data-action="edit" style="padding:4px 8px;background:#eee;border-radius:6px">Edit</button>' +
              '<button class="btn" data-action="delete" style="padding:4px 8px;background:#eee;border-radius:6px">Delete</button>' +
            '</div>' : '') +
        '</div>';
      entry._marker.bindPopup(html);

      entry._marker.off('popupopen').on('popupopen', function(e){
        if (!(unlocked && editModeEl.checked)) return;
        var el = e.popup.getElement(); if (!el) return;
        var editBtn = el.querySelector('[data-action="edit"]');
        var delBtn  = el.querySelector('[data-action="delete"]');

        if (editBtn) editBtn.addEventListener('click', function(){ openEditModal(entry); });
        if (delBtn) delBtn.addEventListener('click', async function(){
          if (!confirm("Delete this marker?")) return;
          await deleteDoc(doc(db, "markers", entry.id));
        });
      });
    }

    function ensureCluster(type){
      if (type === "penthouse") return clusters.penthouse;
      if (type === "office")    return clusters.office;
      if (type === "motel")     return clusters.motel;
      return clusters.apartment;
    }

    function createOrUpdateMarker(entry){
      var m = markers.get(entry.id);
      var t = (entry.type || "apartment").toLowerCase();
      if (!m) {
        m = {
          id: entry.id,
          name: entry.name,
          x: entry.x,
          y: entry.y,
          type: entry.type || "apartment",
          links: entry.links || [],
          shabby: entry.shabby || "",
          nice: entry.nice || ""
        };
        m._marker = L.marker([m.y, m.x], {
          draggable: !!(unlocked && editModeEl.checked),
          autoPan: true,
          icon: iconFor(m)
        })
        .bindTooltip(m.name || "Property", {direction:"top", offset:[0,-10]});
        ensureCluster(t).addLayer(m._marker);
        markers.set(entry.id, m);
        setMarkerPopup(m);

        m._marker.on('dragend', async function(e){
          var pos = e.target.getLatLng();
          await updateDoc(doc(db, "markers", m.id), { y: pos.lat, x: pos.lng, updatedAt: serverTimestamp() });
        });
      } else {
        // move cluster if type changed
        var oldType = (m.type || "apartment").toLowerCase();
        if (oldType !== t && m._marker){
          ensureCluster(oldType).removeLayer(m._marker);
          ensureCluster(t).addLayer(m._marker);
        }
        m.name = entry.name;
        m.x = entry.x;
        m.y = entry.y;
        m.type = entry.type;
        m.links = entry.links;
        m.shabby = entry.shabby;
        m.nice = entry.nice;
        if (m._marker) {
          m._marker.setLatLng([m.y, m.x]);
          m._marker.setIcon(iconFor(m));
          if (m._marker.setTooltipContent) m._marker.setTooltipContent(m.name || "Property");
          setMarkerPopup(m);
        }
      }
    }

    function removeMarker(id){
      var m = markers.get(id);
      if (m && m._marker){
        var t = (m.type || "apartment").toLowerCase();
        ensureCluster(t).removeLayer(m._marker);
      }
      markers.delete(id);
    }

    // ===== Add Modal logic (explicit-close) =====
    let pendingLatLng = null;
    let isAddModalOpen = false;

    function buildLinksFields(type){
      linksArea.innerHTML = "";
      if (type === "apartment") {
        linksArea.innerHTML =
          '<div class="grid-2">' +
            '<label><span>Shabby Apartment URL</span><input id="f-shabby" type="url" placeholder="https://imgur.com/a/…"></label>' +
            '<label><span>Nice Apartment URL</span><input id="f-nice" type="url" placeholder="https://imgur.com/a/…"></label>' +
          '</div>';
      } else if (type === "office") {
        linksArea.innerHTML = '<label><span>Office URL</span><input id="f-office" type="url" placeholder="https://imgur.com/a/…"></label>';
      } else if (type === "motel") {
        linksArea.innerHTML = '<label><span>Motel Album URL</span><input id="f-motel" type="url" placeholder="https://imgur.com/a/…"></label>';
      } else if (type === "penthouse") {
        var wrap = document.createElement("div");
        wrap.className = "row";
        wrap.innerHTML =
          '<div class="grid-2">' +
            '<label><span>Number of links (1–8)</span><input id="f-count" type="number" value="1" min="1" max="8"></label>' +
            '<div class="row"><span class="muted">Each link can have a custom label.</span></div>' +
          '</div>' +
          '<div id="ph-rows" class="row"></div>';
        linksArea.appendChild(wrap);

        var phRows = wrap.querySelector("#ph-rows");
        var fCount = wrap.querySelector("#f-count");

        function renderRows(){
          var n = parseInt(fCount.value || "1", 10);
          if (isNaN(n)) n = 1;
          n = Math.max(1, Math.min(8, n));
          phRows.innerHTML = "";
          for (var i=0;i<n;i++){
            var row = document.createElement("div");
            row.className = "link-row";
            row.innerHTML =
              '<input type="text" class="ph-label" placeholder="Album '+(i+1)+'">' +
              '<input type="url"  class="ph-url"   placeholder="https://imgur.com/a/…">';
            phRows.appendChild(row);
          }
        }
        fCount.addEventListener("input", renderRows);
        renderRows();
      }
    }

    function openAddModal(latlng){
      pendingLatLng = latlng;
      isAddModalOpen = true;
      coordsNote.textContent = "Placing at x="+latlng.lng.toFixed(1)+", y="+latlng.lat.toFixed(1);
      fName.value = "";
      fType.value = "apartment";
      buildLinksFields("apartment");
      addModal.classList.add("show");
    }
    function closeAddModal(){
      addModal.classList.remove("show");
      pendingLatLng = null;
      isAddModalOpen = false;
    }

    btnCancel.addEventListener("click", closeAddModal);
    fType.addEventListener("change", function(e){ buildLinksFields(e.target.value); });

    btnSave.addEventListener("click", async function(){
      if (!pendingLatLng) { closeAddModal(); return; }
      var name = (fName.value || "").trim();
      if (!name) { alert("Please enter a name."); return; }
      var type = fType.value;
      var lat = pendingLatLng.lat;
      var lng = pendingLatLng.lng;

      var links = [];
      var shabby = "", nice = "";
      if (type === "apartment"){
        shabby = (document.getElementById("f-shabby").value || "").trim();
        nice   = (document.getElementById("f-nice").value   || "").trim();
        if (shabby) links.push({ label:"Shabby Apartment", url:shabby });
        if (nice)   links.push({ label:"Nice Apartment",   url:nice });
      } else if (type === "office"){
        var uo = (document.getElementById("f-office").value || "").trim();
        if (uo) links.push({ label:"Office", url:uo });
      } else if (type === "motel"){
        var um = (document.getElementById("f-motel").value || "").trim();
        if (um) links.push({ label:"Album", url:um });
      } else if (type === "penthouse"){
        var rows = linksArea.querySelectorAll(".link-row");
        for (var i=0;i<rows.length;i++){
          var label = (rows[i].querySelector(".ph-label").value || ("Album "+(i+1))).trim();
          var url   = (rows[i].querySelector(".ph-url").value   || "").trim();
          if (url) links.push({ label: label, url: url });
        }
      }

      await addDoc(collection(db, "markers"), {
        name: name,
        type: type,
        links: links,
        x: lng,
        y: lat,
        shabby: (type === "apartment") ? (shabby || "") : "",
        nice:   (type === "apartment") ? (nice   || "") : "",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      closeAddModal();
      toast("Property added.");
    });

    // ===== Edit modal =====
    function buildEditFields(type, entry){
      editBody.innerHTML = "";
      var nameRow = document.createElement("div");
      nameRow.className = "row";
      nameRow.innerHTML = '<label><span>Name</span><input id="e-name" type="text" value="'+(entry.name||"")+'"></label>';
      editBody.appendChild(nameRow);

      var typeRow = document.createElement("div");
      typeRow.className = "row";
      typeRow.innerHTML =
        '<label><span>Type</span>' +
          '<select id="e-type">' +
            '<option value="apartment" '+(entry.type==="apartment"?'selected':'')+'>Apartment</option>' +
            '<option value="office" '+(entry.type==="office"?'selected':'')+'>Office</option>' +
            '<option value="motel" '+(entry.type==="motel"?'selected':'')+'>Motel</option>' +
            '<option value="penthouse" '+(entry.type==="penthouse"?'selected':'')+'>Penthouse</option>' +
          '</select>' +
        '</label>';
      editBody.appendChild(typeRow);

      var linksWrap = document.createElement("div");
      linksWrap.id = "e-links";
      linksWrap.className = "row";
      editBody.appendChild(linksWrap);

      var links = (entry.links && entry.links.slice) ? entry.links.slice() : entryLinks(entry).slice();

      if (type === "apartment"){
        var shabby = "";
        var nice = "";
        for (var i=0;i<links.length;i++){
          if (links[i].label && /shabby/i.test(links[i].label)) shabby = links[i].url;
          if (links[i].label && /nice/i.test(links[i].label))   nice   = links[i].url;
        }
        if (!shabby) shabby = entry.shabby || "";
        if (!nice)   nice   = entry.nice   || "";
        linksWrap.innerHTML =
          '<div class="grid-2">' +
            '<label><span>Shabby Apartment URL</span><input id="e-shabby" type="url" value="'+shabby+'"></label>' +
            '<label><span>Nice Apartment URL</span><input id="e-nice" type="url" value="'+nice+'"></label>' +
          '</div>';
      } else if (type === "office") {
        var urlO = (links[0] && links[0].url) ? links[0].url : "";
        linksWrap.innerHTML = '<label><span>Office URL</span><input id="e-office" type="url" value="'+urlO+'"></label>';
      } else if (type === "motel") {
        var urlM = (links[0] && links[0].url) ? links[0].url : "";
        linksWrap.innerHTML = '<label><span>Motel Album URL</span><input id="e-motel" type="url" value="'+urlM+'"></label>';
      } else if (type === "penthouse") {
        var wrap = document.createElement("div");
        wrap.className = "row";
        var count = links.length > 0 ? links.length : 1;
        if (count < 1) count = 1;
        if (count > 8) count = 8;
        wrap.innerHTML =
          '<div class="grid-2">' +
            '<label><span>Number of links (1–8)</span><input id="e-count" type="number" value="'+count+'" min="1" max="8"></label>' +
            '<div class="row"><span class="muted">Each link can have a custom label.</span></div>' +
          '</div>' +
          '<div id="e-phrows" class="row"></div>';
        linksWrap.appendChild(wrap);

        var rows = wrap.querySelector("#e-phrows");
        var eCount = wrap.querySelector("#e-count");

        function draw(n){
          rows.innerHTML = "";
          for(var i=0;i<n;i++){
            var Lk = links[i] || {};
            var row = document.createElement("div");
            row.className = "link-row";
            row.innerHTML =
              '<input type="text" class="e-label" value="'+(Lk.label || ('Album '+(i+1)))+'">' +
              '<input type="url"  class="e-url"   value="'+(Lk.url   || '')+'">';
            rows.appendChild(row);
          }
        }
        draw(count);
        eCount.addEventListener("input", function(){
          var n = parseInt(eCount.value || "1", 10);
          if (isNaN(n)) n = 1;
          if (n < 1) n = 1;
          if (n > 8) n = 8;
          draw(n);
        });
      }
    }

    function openEditModal(entry){
      editingEntry = {
        id: entry.id,
        name: entry.name,
        type: entry.type || "apartment",
        links: (entry.links && entry.links.slice) ? entry.links.slice() : entryLinks(entry).slice(),
        shabby: entry.shabby || "",
        nice: entry.nice || ""
      };
      buildEditFields(editingEntry.type, editingEntry);
      editModal.classList.add("show");

      // handle type change
      function onTypeChange(e){
        if (e && e.target && e.target.id === "e-type"){
          buildEditFields(e.target.value, editingEntry);
          editBody.addEventListener("change", onTypeChange, { once:true });
        }
      }
      editBody.addEventListener("change", onTypeChange, { once:true });
    }

    editCancel.addEventListener("click", function(){ editModal.classList.remove("show"); editingEntry=null; });

    editSave.addEventListener("click", async function(){
      if (!editingEntry) return;
      var name = (document.getElementById("e-name").value || "").trim();
      var type = document.getElementById("e-type").value;

      var links = [];
      var shabby = "", nice = "";
      if (type === "apartment"){
        shabby = (document.getElementById("e-shabby").value || "").trim();
        nice   = (document.getElementById("e-nice").value   || "").trim();
        if (shabby) links.push({ label:"Shabby Apartment", url:shabby });
        if (nice)   links.push({ label:"Nice Apartment",   url:nice });
      } else if (type === "office"){
        var uo = (document.getElementById("e-office").value || "").trim();
        if (uo) links.push({ label:"Office", url:uo });
      } else if (type === "motel"){
        var um = (document.getElementById("e-motel").value || "").trim();
        if (um) links.push({ label:"Album", url:um });
      } else if (type === "penthouse"){
        var rows = editBody.querySelectorAll("#e-phrows .link-row");
        for (var i=0;i<rows.length;i++){
          var label = (rows[i].querySelector(".e-label").value || ("Album "+(i+1))).trim();
          var url   = (rows[i].querySelector(".e-url").value   || "").trim();
          if (url) links.push({ label: label, url: url });
        }
      }

      await updateDoc(doc(db,"markers",editingEntry.id),{
        name: name,
        type: type,
        links: links,
        shabby: (type==="apartment") ? (shabby || "") : "",
        nice:   (type==="apartment") ? (nice   || "") : "",
        updatedAt: serverTimestamp()
      });
      editModal.classList.remove("show");
      editingEntry=null;
    });

    // ===== Statistics =====
    function renderStats(){
      var counts = { total: 0, apartment: 0, penthouse: 0, office: 0, motel: 0 };
      markers.forEach(function(m){
        counts.total++;
        var t = (m.type || "apartment").toLowerCase();
        if (t === "apartment") counts.apartment++;
        else if (t === "penthouse") counts.penthouse++;
        else if (t === "office") counts.office++;
        else if (t === "motel") counts.motel++;
      });
      statBody.innerHTML =
        '<div style="padding:14px">' +
          '<p><strong>Total properties:</strong> '+counts.total+'</p>' +
          '<p>Apartments: '+counts.apartment+'</p>' +
          '<p>Penthouses: '+counts.penthouse+'</p>' +
          '<p>Offices: '+counts.office+'</p>' +
          '<p>Motels: '+counts.motel+'</p>' +
        '</div>';
    }

    // ===== Map + data =====
    function init(imageUrl, w, h){
      mapEl.style.display = "block";

      var bounds = [[0,0],[h,w]];
      var mapOpts = { crs: L.CRS.Simple, minZoom: -2, maxZoom: 5, zoomControl: true, attributionControl: false };
      map = L.map("map", mapOpts);
      L.imageOverlay(imageUrl, bounds).addTo(map);
      map.fitBounds(bounds);

      // Add clusters to map
      clusters.apartment.addTo(map);
      clusters.penthouse.addTo(map);
      clusters.office.addTo(map);
      clusters.motel.addTo(map);

      // Scale icons with zoom (min 16, max 48)
      map.on("zoomend", function(){
        var z = map.getZoom();
        currentIconSize = Math.max(16, Math.min(48, z * 4));
        markers.forEach(function(m){ if (m._marker) m._marker.setIcon(iconFor(m)); });
      });

      // Add marker (only when unlocked + add mode)
      map.on("click", function(e){
        if (isAddModalOpen) return; // keep modal open until Save/Cancel
        if (!(unlocked && addModeEl.checked)) return;
        openAddModal(e.latlng);
      });

      setLockedUI(true);

      var colRef = collection(db, "markers");
      onSnapshot(colRef, function(snap){
        var seen = new Set();
        snap.forEach(function(d){
          var v = d.data();
          var entry = {
            id: d.id,
            name: (v && v.name) ? v.name : "Property",
            x: v && v.x,
            y: v && v.y,
            type: (v && v.type) ? v.type : "apartment",
            links: (v && v.links && v.links.slice) ? v.links : [],
            shabby: (v && v.shabby) ? v.shabby : "",
            nice:   (v && v.nice)   ? v.nice   : ""
          };
          createOrUpdateMarker(entry);
          seen.add(d.id);
        });
        // Remove stale
        Array.from(markers.keys()).forEach(function(id){
          if (!seen.has(id)) removeMarker(id);
        });
        // Update badges
        if (statModal.classList.contains("show")) renderStats();
        statusEl.textContent = "Loaded " + markers.size + " properties";
        hintEl.textContent = "Ready";
        // Sync icon size initially
        map.fire("zoomend");
      });

      // Unlock/Lock
      unlockBtn.addEventListener("click", async function(){
        var pass = prompt("Password:");
        if (pass !== LOCAL_EDIT_PASSWORD) { alert("Wrong password."); return; }
        await signInAnonymously(auth);
        setLockedUI(false);
      });
      lockBtn.addEventListener("click", async function(){
        await signOut(auth);
        setLockedUI(true);
      });

      editModeEl.addEventListener("change", applyEditMode);
    }

    // Image loader
    function tryLoadImage(i){
      var idx = (typeof i === "number") ? i : 0;
      if (idx >= MAP_CANDIDATES.length){
        statusEl.textContent = "Could not find map.jpg/jpeg/png next to index.html.";
        console.warn("[map] no candidates worked");
        return;
      }
      var src = MAP_CANDIDATES[idx] + "?v=" + Date.now();
      var img = new Image();
      img.onload = function(){ init(src, img.naturalWidth, img.naturalHeight); };
      img.onerror = function(){ tryLoadImage(idx + 1); };
      img.src = src;
    }

    // ===== Settings menu & actions =====
    settingsBtn.addEventListener("click", function(e){
      e.stopPropagation();
      var open = settingsMenu.style.display === "block";
      settingsMenu.style.display = open ? "none" : "block";
    });
    document.addEventListener("click", function(){ settingsMenu.style.display = "none"; });

    // Export markers (JSON)
    menuExport.addEventListener("click", function(){
      settingsMenu.style.display = "none";
      var arr = [];
      markers.forEach(function(m){
        arr.push({
          name: m.name,
          x: m.x,
          y: m.y,
          type: m.type,
          links: m.links,
          shabby: m.shabby,
          nice: m.nice
        });
      });
      var blob = new Blob([JSON.stringify(arr, null, 2)], { type: "application/json" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "markers.json";
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    });

    // Statistics
    menuStats.addEventListener("click", function(){
      settingsMenu.style.display = "none";
      renderStats();
      statModal.classList.add("show");
    });
    statClose.addEventListener("click", function(){ statModal.classList.remove("show"); });

    // Changelog
    menuChangelog.addEventListener("click", function(){
      settingsMenu.style.display = "none";
      openChangelog();
    });
    chgClose.addEventListener("click", function(){ chgModal.classList.remove("show"); });
    chgCloseX.addEventListener("click", function(){ chgModal.classList.remove("show"); });

    function openChangelog(){
      chgBody.innerHTML = '<div style="padding:14px">Loading commits…</div>';
      chgModal.classList.add("show");
      var cacheKey = "chg_" + REPO_OWNER + "_" + REPO_NAME;
      var cached = null;
      try { cached = sessionStorage.getItem(cacheKey); } catch(e) {}
      if (cached) { chgBody.innerHTML = cached; return; }
      var url = "https://api.github.com/repos/" + REPO_OWNER + "/" + REPO_NAME + "/commits?per_page=20";
      fetch(url, { headers: { "Accept": "application/vnd.github+json" } })
        .then(function(res){
          if (!res.ok) throw new Error("GitHub API " + res.status);
          return res.json();
        })
        .then(function(commits){
          var html = "";
          for (var i=0;i<commits.length;i++){
            var c = commits[i];
            var commit = c.commit ? c.commit : {};
            var authorObj = commit.author ? commit.author : null;
            var authorName = authorObj && authorObj.name ? authorObj.name : (c.author && c.author.login ? c.author.login : "Unknown");
            var msg = commit.message ? String(commit.message).trim() : "";
            var parts = msg.split(/\r?\n/);
            var title = parts.shift() || "Commit";
            var body = parts.join("\n").trim();
            var dstr = (authorObj && authorObj.date) ? authorObj.date : (commit.committer && commit.committer.date ? commit.committer.date : "");
            var when = "";
            try { when = dstr ? new Date(dstr).toLocaleString() : ""; } catch(e) { when = ""; }

            html += '' +
              '<div class="commit" style="padding:12px 14px; border-bottom:1px solid #eee">' +
                '<h4 style="margin:0 0 6px; font-size:14px">'+escapeHtml(title)+'</h4>' +
                (body ? '<div class="muted" style="white-space:pre-wrap">'+escapeHtml(body)+'</div>' : '') +
                '<small class="muted">'+escapeHtml(authorName)+' — '+escapeHtml(when)+'</small>' +
              '</div>';
          }
          chgBody.innerHTML = html || '<div style="padding:14px">No recent commits.</div>';
          try { sessionStorage.setItem(cacheKey, chgBody.innerHTML); } catch(e) {}
        })
        .catch(function(err){
          chgBody.innerHTML = '<div style="padding:14px;color:#b00020">Failed to load commits: '+escapeHtml(err.message)+'</div>';
        });
    }

    function escapeHtml(s){
      var map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' };
      return String(s).replace(/[&<>"]/g, function(c){ return map[c]; });
    }

    // Boot
    tryLoadImage();
  </script>
</body>
</html>
