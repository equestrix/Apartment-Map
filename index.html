<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    :root{
      --main:#93c47d; --secondary:#b6d7a8; --accent:#d9ead3;
      --sea:#0fa8d2; --ink:#111;
    }
    html,body{ height:100%; margin:0; background:var(--sea); }
    .leaflet-container{ background:var(--sea); }

    /* Layout */
    #map{ position:absolute; inset:56px 0 0 0; display:none; }
    #toolbar{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; gap:12px; align-items:center; padding:8px 12px;
      background:var(--main); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    #brand{ display:flex; align-items:center; gap:8px; }
    #brand img{ height:36px; width:auto; display:block; }
    #toolbar label{ display:flex; align-items:center; gap:6px; }
    #toolbar input[type="checkbox"]{ transform:translateY(1px); }
    #toolbar button{
      border:none; padding:8px 12px; border-radius:8px; cursor:pointer;
      background:#fff; color:#111; font-weight:700;
    }
    #toolbar button:hover{ filter:brightness(.97); color:#111; }

    /* Badges */
    #status{
      position:fixed; bottom:8px; left:10px; font:13px/1.3 system-ui; color:#111;
      background:rgba(255,255,255,.9); padding:4px 8px; border-radius:6px; z-index:1200;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    #version{
      position:fixed; bottom:8px; right:10px; font:12px/1 monospace;
      color:rgba(255,255,255,.92); background:rgba(0,0,0,.6);
      padding:2px 6px; border-radius:4px; z-index:1200;
    }

    /* Settings menu */
    #settings{ margin-left:auto; position:relative; }
    #settingsBtn{ background:#fff; color:#111; }
    #settingsMenu{
      position:absolute; right:0; top:44px; min-width:260px;
      background:#fff; color:#111; border-radius:10px;
      box-shadow:0 12px 24px rgba(0,0,0,.2);
      display:none; overflow:hidden; z-index:1400;
    }
    #settingsMenu button{
      display:block; width:100%; text-align:left; padding:10px 12px;
      border:0; background:transparent; cursor:pointer; color:#111;
    }
    #settingsMenu button:hover{ background:#f2f2f2; color:#111; }

    /* Modals */
    .modal{ position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(0,0,0,.45); z-index:1500; opacity:0; pointer-events:none; transition:opacity .18s ease; }
    .modal.show{ opacity:1; pointer-events:auto; }
    .card{
      width:min(560px, calc(100vw - 24px)); max-height:85vh; overflow:auto;
      background:var(--secondary); color:#111; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      transform:translateY(6px); transition:transform .18s ease;
    }
    .modal.show .card{ transform:translateY(0); }
    .card header{ padding:12px 14px; background:var(--main); border-radius:12px 12px 0 0; font-weight:700; position:relative; }
    .card main{ padding:14px; display:grid; gap:12px; background:var(--accent); }
    .card footer{ padding:12px 14px; background:var(--secondary); border-radius:0 0 12px 12px; display:flex; gap:8px; justify-content:flex-end; }
    .modal .btn{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; }
    .btn.ghost{ background:#eee; color:#111; }
    .row{ display:grid; gap:6px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    input[type="text"], input[type="url"], input[type="number"], select{
      width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; font:14px system-ui; background:#fff; color:#111;
    }
    .muted{ color:#333; font-size:12px; }
    .link-row{ display:grid; grid-template-columns:1fr 2fr; gap:8px; align-items:center; }

    /* Popups */
    .leaflet-popup-content-wrapper{ background:var(--accent); border:2px solid var(--main); border-radius:10px; }
    .leaflet-popup-tip{ background:var(--accent); }
    .popup h3{
      margin:0 0 6px 0; font-size:16px; color:#111;
      background:var(--main); padding:4px 6px; border-radius:6px; display:inline-block;
    }
    .popup p{ margin:0 0 6px; }
    .popup small{ color:#333; display:block; margin-top:6px; }
    .popup a{ color:#003366; font-weight:600; text-decoration:none; border-bottom:1px solid transparent; }
    .popup a:hover{ border-bottom-color:#003366; }

    .area-label{
      background:rgba(255,255,255,.85);
      padding:2px 6px; border-radius:6px; font:12px/1.2 system-ui; color:#111;
      border:1px solid rgba(0,0,0,.1); white-space:nowrap;
    }

    /* Layers control — top-left under banner, bumped down more */
    .leaflet-top.leaflet-left .leaflet-control.layers-toggle { margin:118px 0 0 10px; }
    .leaflet-control.layers-toggle .btn{
      display:flex; align-items:center; gap:6px;
      background:#fff; color:#111; border-radius:8px; padding:8px 10px;
      font:13px/1.2 system-ui; border:1px solid #ddd;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .leaflet-control.layers-toggle .btn:hover{ background:#f7f7f7; }
    .leaflet-control.layers-toggle .panel{
      position:absolute; left:0; top:40px;
      background:#fff; color:#111; border-radius:10px; border:1px solid #ddd;
      box-shadow:0 12px 24px rgba(0,0,0,.2);
      padding:8px 10px; min-width:180px; display:none;
    }
    .leaflet-control.layers-toggle .panel label{
      display:flex; align-items:center; gap:8px; padding:6px 4px; font:13px/1.2 system-ui;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <div id="brand">
      <img src="Dynasty8-GTAV-Logo.png" alt="Dynasty 8">
      <strong>Property Map</strong>
    </div>

    <!-- Hidden until unlocked -->
    <label id="addWrap" style="display:none" title="Enable click‑to‑add mode"><input type="checkbox" id="addMode"> Add</label>
    <label id="editWrap" style="display:none" title="Enable drag/edit mode"><input type="checkbox" id="editMode"> Edit</label>

    <button id="unlockBtn" title="Enter password to edit">Unlock</button>
    <button id="lockBtn" style="display:none" title="Lock editing">Lock</button>

    <span id="hint">Syncing…</span>

    <div id="settings" style="margin-left:auto">
      <button id="settingsBtn" title="Open settings">⚙️ Settings</button>
      <div id="settingsMenu" role="menu" aria-hidden="true">
        <button id="menuExport"      title="Download markers.json">Export markers</button>
        <button id="menuChangelog"   title="View recent commits">Changelog</button>
        <button id="menuStats"       title="Totals & last updated">Statistics</button>
        <button id="menuToggleAreas" title="Show/hide area names">Toggle area names</button>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <div id="status">Loading map…</div>
  <div id="version"></div>

  <!-- Add Modal -->
  <div id="addModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Add Property</header>
    <main>
      <div class="row"><label><span>Name</span><input id="f-name" type="text" placeholder="e.g., Eclipse Towers Apt. 3"></label></div>
      <div class="grid-2">
        <label><span>Type</span>
          <select id="f-type">
            <option value="apartment" selected>Apartment</option>
            <option value="office">Office</option>
            <option value="motel">Motel</option>
            <option value="penthouse">Penthouse</option>
          </select>
        </label>
        <div class="row"><span class="muted">Type controls link fields.</span></div>
      </div>
      <div id="linksArea" class="row"></div>
      <div class="muted" id="coordsNote">Will be placed where you clicked.</div>
    </main>
    <footer><button id="btnCancel" class="btn ghost">Cancel</button><button id="btnSave" class="btn primary">Save</button></footer>
  </div></div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Edit Property</header>
    <main id="editBody"></main>
    <footer><button id="editCancel" class="btn ghost">Cancel</button><button id="editSave" class="btn primary">Save</button></footer>
  </div></div>

  <!-- Changelog Modal -->
  <div id="changelogModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Changelog <button id="chgCloseX" class="btn ghost" style="position:absolute;right:10px;top:8px">×</button></header>
    <main id="chgBody"><div style="padding:14px">Loading commits…</div></main>
    <footer><button id="chgClose" class="btn primary">Close</button></footer>
  </div></div>

  <!-- Stats Modal -->
  <div id="statsModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Statistics</header>
    <main id="statBody"></main>
    <footer><button id="statClose" class="btn primary">Close</button></footer>
  </div></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp,
      enableIndexedDbPersistence, getDocsFromCache, getDocsFromServer
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Build =====
    const VERSION = "beta 2.0.3";
    document.getElementById("version").textContent = VERSION;

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCcfOML9FD1Q5vcoCb3NdIlFKtx3LAovBc",
      authDomain: "dynasty8-property-map.firebaseapp.com",
      projectId: "dynasty8-property-map",
      storageBucket: "dynasty8-property-map.firebasestorage.app",
      messagingSenderId: "849316207524",
      appId: "1:849316207524:web:9c921ad842fc188d027f31",
      measurementId: "G-VXG629H337"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    try { await signInAnonymously(auth); } catch(e){ console.warn("[auth] anon failed:", e?.message||e); }
    try { await enableIndexedDbPersistence(db); } catch(e){ console.warn("[fs] persistence:", e?.message||e); }

    // ===== DOM =====
    const addModeEl  = document.getElementById("addMode");
    const editModeEl = document.getElementById("editMode");
    const addWrap    = document.getElementById("addWrap");
    const editWrap   = document.getElementById("editWrap");
    const unlockBtn  = document.getElementById("unlockBtn");
    const lockBtn    = document.getElementById("lockBtn");
    const hintEl     = document.getElementById("hint");
    const statusEl   = document.getElementById("status");
    const mapEl      = document.getElementById("map");

    const settingsBtn   = document.getElementById("settingsBtn");
    const settingsMenu  = document.getElementById("settingsMenu");
    const menuExport    = document.getElementById("menuExport");
    const menuChangelog = document.getElementById("menuChangelog");
    const menuStats     = document.getElementById("menuStats");
    const menuToggleAreas = document.getElementById("menuToggleAreas");

    const chgModal  = document.getElementById("changelogModal");
    const chgBody   = document.getElementById("chgBody");
    const chgClose  = document.getElementById("chgClose");
    const chgCloseX = document.getElementById("chgCloseX");
    const statModal = document.getElementById("statsModal");
    const statBody  = document.getElementById("statBody");
    const statClose = document.getElementById("statClose");

    const addModal   = document.getElementById("addModal");
    const fName      = document.getElementById("f-name");
    const fType      = document.getElementById("f-type");
    const linksArea  = document.getElementById("linksArea");
    const btnCancel  = document.getElementById("btnCancel");
    const btnSave    = document.getElementById("btnSave");
    const coordsNote = document.getElementById("coordsNote");

    const editModal  = document.getElementById("editModal");
    const editBody   = document.getElementById("editBody");
    const editCancel = document.getElementById("editCancel");
    const editSave   = document.getElementById("editSave");
    let editingEntry = null;

    // ===== State =====
    let unlocked = false;
    let map, currentIconSize = 32;
    let imageWidth = 0, imageHeight = 0;
    let imageBounds = null;

    const groups = {
      apartment: L.layerGroup(), penthouse: L.layerGroup(),
      office: L.layerGroup(), motel: L.layerGroup()
    };
    const markers = new Map();
    let latestUpdatedAtMillis = 0;

    let zonesOverlay = null;
    const areaLabelsLayer = L.layerGroup();

    const toast = (m)=>{ hintEl.textContent = m; };

    // ===== Icons by type =====
    function iconFor(entry, size){
      const t = (entry.type || "apartment").toLowerCase();
      const files = {
        apartment: "house-apartment.png",
        penthouse: "house-penthouse.png",
        office:    "house-office.png",
        motel:     "house-motel.png"
      };
      const s = size || currentIconSize;
      return L.icon({ iconUrl: files[t] || files.apartment, iconSize:[s,s], iconAnchor:[s/2,s/2], tooltipAnchor:[0,-s/2] });
    }

    function entryLinks(entry){
      if (entry?.links?.length) return entry.links;
      const arr = [];
      if (entry?.shabby) arr.push({ label:"Shabby Apartment", url:entry.shabby });
      if (entry?.nice)   arr.push({ label:"Nice Apartment",   url:entry.nice });
      return arr;
    }
    function renderLinksHTML(entry){
      const t = (entry.type || "apartment").toLowerCase();
      const links = entryLinks(entry);
      if (t === "apartment"){
        let shabby=null, nice=null;
        for (let i=0;i<links.length;i++){
          if (!shabby && /shabby/i.test(links[i].label)) shabby=links[i];
          if (!nice && /nice/i.test(links[i].label)) nice=links[i];
        }
        return (shabby?`<p><a href="${shabby.url}" target="_blank" rel="noopener">Shabby Apartment</a></p>`:"") +
               (nice?  `<p><a href="${nice.url}"   target="_blank" rel="noopener">Nice Apartment</a></p>`  :"");
      }
      if (t === "office"){
        const link = links[0];
        return link ? `<p><a href="${link.url}" target="_blank" rel="noopener">Office</a></p>` : "";
      }
      if (t === "motel"){
        const link = links[0];
        const note = '<div style="color:#d60000;font-weight:700;margin-top:6px">Don’t use this link in your listing, you need a door photo!</div>';
        return (link? `<p><a href="${link.url}" target="_blank" rel="noopener">Album</a></p>` : "") + note;
      }
      if (t === "penthouse"){
        let html = "";
        for (let j=0;j<links.length;j++){
          const Lk = links[j];
          html += `<p><a href="${Lk.url||''}" target="_blank" rel="noopener">${Lk.label||"Album"}</a></p>`;
        }
        return html;
      }
      let out = "";
      for (let k=0;k<links.length;k++){
        const lk = links[k];
        out += `<p><a href="${lk.url||''}" target="_blank" rel="noopener">${lk.label||"Link"}</a></p>`;
      }
      return out;
    }

    // ===== Marker popup / behavior =====
    function setMarkerPopup(entry){
      const html =
        `<div class="popup">
          <h3>${entry.name || "Property"}</h3>
          <p><strong>Type:</strong> ${entry.type || "apartment"}</p>
          ${renderLinksHTML(entry)}
          <small>Coords: x=${entry.x.toFixed(1)}, y=${entry.y.toFixed(1)}</small>
        </div>`;
      entry._marker.bindPopup(html, { autoPan:false, keepInView:false });

      entry._marker.off('popupopen').on('popupopen', (e) => {
        if (!(unlocked && editModeEl.checked)) return;
        const el = e.popup.getElement();
        if (!el) return;
        el.querySelector(".popup h3").insertAdjacentHTML("afterend",
          `<div style="margin-top:6px;display:flex;gap:8px">
             <button class="btn" data-action="edit" style="padding:4px 8px;background:#eee;border-radius:6px">Edit</button>
             <button class="btn" data-action="delete" style="padding:4px 8px;background:#eee;border-radius:6px">Delete</button>
           </div>`
        );
        const editBtn = el.querySelector('[data-action="edit"]');
        const delBtn  = el.querySelector('[data-action="delete"]');
        if (editBtn) {
          editBtn.addEventListener('click', (evt) => {
            evt.stopPropagation();
            openEditModal(entry);
          });
        }
        if (delBtn) {
          delBtn.addEventListener('click', async (evt) => {
            evt.stopPropagation();
            if (!confirm("Delete this marker?")) return;
            try {
              await deleteDoc(doc(db, "markers", entry.id));
            } catch(err) {
              alert("Failed to delete: " + (err?.message || err));
            }
          });
        }
      });
    }

    // The rest of your original code (createOrUpdateMarker, applyEditMode, setLockedUI, init, tryLoadImage, area loading, data wiring, add/edit modals etc.) should remain **exactly as you had it**.

    // ===== Boot =====
    tryLoadImage();
  </script>
</body>
</html>
