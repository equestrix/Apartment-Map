<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apartment Map ¬∑ v0.7.0</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root {
      --banner-h: 68px; /* keep UI from overlapping banner */
    }
    html, body { height: 100%; margin: 0; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:#0b0f14; color:#e8edf2; }

    /* Banner */
    .banner { position: fixed; top:0; left:0; right:0; height: var(--banner-h); display:flex; align-items:center; gap:12px; padding:10px 14px; background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(2,6,23,.8)); backdrop-filter: blur(6px); z-index: 12000; border-bottom:1px solid rgba(255,255,255,.08); }
    .logo { font-weight:700; letter-spacing:.4px; }
    .version { opacity:.7; font-size:.9rem; }
    .spacer { flex:1; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); }
    .btn { cursor:pointer; user-select:none; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:#e8edf2; padding:6px 10px; border-radius:10px; transition: .15s ease; }
    .btn:hover { background:rgba(255,255,255,.12); }

    /* Map container */
    #map { position: absolute; inset: 0; top: var(--banner-h); }

    /* Position Leaflet controls below banner (top-left) */
    .leaflet-top.leaflet-left { margin-top: calc(var(--banner-h) + 10px); margin-left: 10px; }
    .leaflet-control-zoom { box-shadow: 0 6px 24px rgba(0,0,0,.3); border-radius: 12px; }
    .leaflet-control-layers { box-shadow: 0 6px 24px rgba(0,0,0,.3); border-radius: 12px; }

    /* Property popup card */
    .prop-card { min-width: 240px; max-width: 320px; color:#0b0f14; }
    .prop-card .hdr { font-weight:700; font-size:1rem; margin-bottom:6px; }
    .prop-card .meta { font-size:.9rem; color:#334155; margin-bottom:8px; }
    .prop-card .actions { display:flex; gap:8px; margin-top:10px; }
    .prop-card .actions .btn { padding:6px 8px; }

    /* Elevate popups above map and allow clicks */
    .leaflet-popup-content-wrapper { pointer-events: auto; }
    .prop-card, .prop-card * { pointer-events: auto; }
    .prop-card { position: relative; z-index: 10000; }

    /* Password modal */
    .modal-backdrop { position: fixed; inset:0; background: rgba(2,6,23,.6); display:none; align-items:center; justify-content:center; z-index:13000; }
    .modal { width: min(440px, 92vw); background: #0f172a; color:#e8edf2; border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow: 0 12px 50px rgba(0,0,0,.45); padding:18px; }
    .modal h3 { margin:0 0 8px 0; }
    .modal .row { display:flex; gap:10px; margin-top:12px; }
    .modal input { flex:1; background:#0b1223; color:#e8edf2; border:1px solid rgba(255,255,255,.14); border-radius:10px; padding:10px; }

    /* Small footer in banner */
    .status { font-size:.85rem; opacity:.8; }

    /* Hide area labels entirely (per request) */
    .area-label { display:none !important; }
  </style>
</head>
<body>
  <header class="banner">
    <div class="logo">üè† Apartment Map</div>
    <div class="version">v0.7.0</div>
    <div class="spacer"></div>
    <div class="pill status" id="status">Ready</div>
    <button id="btn-auth" class="btn" title="Enable editing with a password">üîí Unlock Editing</button>
  </header>

  <div id="map" role="application" aria-label="Interactive apartment map"></div>

  <!-- Password Modal -->
  <div class="modal-backdrop" id="pw-modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pw-title">
      <h3 id="pw-title">Unlock Editing</h3>
      <p>Enter the edit password to enable in-page editing. (You can change validation logic in code.)</p>
      <div class="row">
        <input id="pw-input" type="password" placeholder="Password" />
        <button id="pw-confirm" class="btn">Unlock</button>
        <button id="pw-cancel" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
  (async function () {
    const APP_VERSION = 'beta 2.0';

    // ------- Helpers -------
    const qs = sel => document.querySelector(sel);
    const $status = qs('#status');
    function setStatus(msg) { $status.textContent = msg; }

    // Resolve asset URLs correctly under GitHub Pages subpaths or Netlify root
    const asset = (p) => new URL(p, document.baseURI).toString();

    // Load JSON safely (optional file friendly)
    async function loadJSON(relPath, {optional=false} = {}) {
      const url = asset(relPath);
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) { if (optional) return null; throw new Error(relPath+': '+res.status); }
        return await res.json();
      } catch (e) {
        if (optional) return null;
        console.error('[json]', relPath, e);
        throw e;
      }
    }

    // Local persistence (for demo). Replace with your backend if needed.
    function loadLocal(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
    }
    function saveLocal(key, val) {
      try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
    }

    // ------- Map init -------
    const map = L.map('map', {
      zoomControl: true,
      center: [0, 0], // will be adjusted after overlay/base load
      zoom: 2,
      minZoom: 1,
      maxZoom: 7,
      worldCopyJump: false,
      attributionControl: false,
    });

    // Move zoom control top-left (default) ‚Äî margins handled by CSS
    // Base tile layer (dark gray as neutral). You can replace this with your GTA image tiles later.
    const base = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    });

    // Optional image overlay (enabled by default if present)
    let overlayLayer = null;
    try {
      // If map-overlay.png exists, load it as an image overlay covering a simple bounds box
      const overlayUrl = asset('map-overlay.png');
      // We probe existence with a HEAD request lightly
      const probe = await fetch(overlayUrl, { method: 'HEAD' });
      if (probe.ok) {
        // Define the bounds you want the overlay to occupy. Adjust to your coordinate system.
        const bounds = [[-256, -256], [256, 256]]; // placeholder square
        overlayLayer = L.imageOverlay(overlayUrl, bounds, { opacity: 0.9 });
      }
    } catch {}

    const layers = {};
    base.addTo(map); layers['Base'] = base;
    if (overlayLayer) { overlayLayer.addTo(map); layers['Overlay'] = overlayLayer; }

    // Layers control, positioned top-left under the banner via CSS margins
    L.control.layers(null, layers, { collapsed: false, position: 'topleft' }).addTo(map);

    // Center map reasonably and shift "down a bit" by panning south
    map.setView([20, 0], 4); // start centered-ish
    map.panBy([0, 80]); // nudge down a bit visually

    // ------- Data load -------
    setStatus('Loading markers‚Ä¶');
    const remoteMarkers = await loadJSON('markers.json', { optional: true }) || [];
    const localMarkers = loadLocal('apt.markers', []);

    // Merge: prefer remote order, overlay any locally edited items by id
    const byId = new Map();
    [...remoteMarkers, ...localMarkers].forEach(m => { if (m && m.id != null) byId.set(String(m.id), m); });
    const markers = Array.from(byId.values());

    // Store for later
    saveLocal('apt.markers', markers);

    // ------- Marker rendering -------
    const markersLayer = L.layerGroup().addTo(map);

    function markerHtml(m) {
      // Area name intentionally removed per request (no labels)
      return `
        <div class="prop-card">
          <div class="hdr">${escapeHtml(m.title || 'Untitled')}</div>
          <div class="meta">${escapeHtml(m.description || '')}</div>
          <div class="actions">
            <button type="button" class="btn" data-action="edit" data-id="${encodeURIComponent(m.id)}">Edit</button>
            <button type="button" class="btn" data-action="delete" data-id="${encodeURIComponent(m.id)}">Delete</button>
          </div>
        </div>`;
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function toLatLng(m) {
      // Expecting stored as {lat, lng}. If your data is in map pixels, convert here.
      return [Number(m.lat) || 0, Number(m.lng) || 0];
    }

    function drawAllMarkers() {
      markersLayer.clearLayers();
      markers.forEach(m => {
        const marker = L.marker(toLatLng(m));
        marker.bindPopup(markerHtml(m));
        marker.addTo(markersLayer);
      });
    }

    drawAllMarkers();
    setStatus(`Loaded ${markers.length} marker${markers.length===1?'':'s'}`);

    // Keep UI clicks from panning the map
    map.on('popupopen', (e) => {
      const el = e.popup.getElement();
      if (el && L && L.DomEvent) {
        L.DomEvent.disableClickPropagation(el);
        L.DomEvent.disableScrollPropagation(el);
      }
      el?.addEventListener('click', ev => ev.stopPropagation(), { capture:true });
      el?.addEventListener('mousedown', ev => ev.stopPropagation(), { capture:true });
    });

    // ------- Editing flow (local only) -------
    let canEdit = false;

    function requireEdit() { if (!canEdit) { openPwModal(); return false; } return true; }

    function findIndexById(id) { return markers.findIndex(m => String(m.id) === String(id)); }

    async function openEditForm(id) {
      const idx = findIndexById(id);
      if (idx < 0) return;
      const m = markers[idx];
      const title = prompt('Title', m.title || '');
      if (title === null) return; // cancelled
      const desc = prompt('Description', m.description || '');
      if (desc === null) return;
      m.title = title; m.description = desc;
      saveLocal('apt.markers', markers);
      drawAllMarkers();
      setStatus('Saved edits locally');
    }

    async function confirmDelete(id) {
      const idx = findIndexById(id);
      if (idx < 0) return;
      if (!confirm('Delete this marker?')) return;
      markers.splice(idx, 1);
      saveLocal('apt.markers', markers);
      drawAllMarkers();
      setStatus('Deleted marker (local)');
    }

    // Global delegated handler for dynamic popup buttons
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      const id = decodeURIComponent(btn.dataset.id || '');
      const action = btn.dataset.action;
      if (action === 'edit')  { if (requireEdit()) openEditForm(id); }
      if (action === 'delete'){ if (requireEdit()) confirmDelete(id); }
    }, { capture: true });

    // ------- Password unlock (modal) -------
    const modal = qs('#pw-modal');
    const ipt = qs('#pw-input');
    qs('#btn-auth').addEventListener('click', openPwModal);
    qs('#pw-cancel').addEventListener('click', closePwModal);
    qs('#pw-confirm').addEventListener('click', tryUnlock);
    ipt.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryUnlock(); });

    function openPwModal(){ modal.style.display = 'flex'; ipt.value=''; ipt.focus(); }
    function closePwModal(){ modal.style.display = 'none'; }
    function tryUnlock(){
      const pw = ipt.value.trim();
      // TODO: replace with your real validation (e.g., compare hash, call an endpoint, etc.)
      if (pw.length >= 1) { // accept any non-empty for now
        canEdit = true;
        closePwModal();
        qs('#btn-auth').textContent = 'üîì Editing Enabled';
        setStatus('Editing unlocked');
      } else {
        alert('Enter a password.');
      }
    }

    // ------- Firestore persistence (optional, future) -------
    // If you re-enable Firebase, prefer initializeFirestore with localCache
    // and replace localStorage save/load with remote CRUD.

  })();
  </script>
</body>
</html>
