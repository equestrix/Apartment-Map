<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    /* THEME TOKENS */
    :root{
      --main:#93c47d; --secondary:#b6d7a8; --accent:#d9ead3;
      --sea:#0fa8d2; --ink:#111; --cardShadow:0 10px 30px rgba(0,0,0,.25);
      --panelBg:#fff; --panelText:#111; --muted:#333; --border:#ddd; --chip:#eee;
      --toastBg:rgba(0,0,0,.85); --toastText:#fff;
    }
    body.dark{
      --main:#2c6139; --secondary:#2f6b42; --accent:#234c32;
      --sea:#0b6e8d; --ink:#eaeaea; --cardShadow:0 12px 28px rgba(0,0,0,.6);
      --panelBg:#1e1e1e; --panelText:#eaeaea; --muted:#b9b9b9; --border:#333; --chip:#2a2a2a;
      --toastBg:rgba(255,255,255,.09); --toastText:#fff;
    }

    html,body{ height:100%; margin:0; background:var(--sea); color:var(--panelText); }
    .leaflet-container{ background:var(--sea); }

    /* Layout */
    #map{ position:absolute; inset:56px 0 0 0; display:none; }
    #toolbar{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; gap:12px; align-items:center; padding:8px 12px;
      background:var(--main); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    #brand{ display:flex; align-items:center; gap:8px; }
    #brand img{ height:36px; width:auto; display:block; }
    #toolbar label{ display:flex; align-items:center; gap:6px; color:var(--ink); }
    #toolbar input[type="checkbox"]{ transform:translateY(1px); }
    #toolbar button{
      border:none; padding:8px 12px; border-radius:8px; cursor:pointer;
      background:#fff; color:#111; font-weight:700;
    }
    #toolbar button:hover{ filter:brightness(.97); color:#111; }

    /* Badges */
    #status{
      position:fixed; bottom:8px; left:10px; font:13px/1.3 system-ui; color:#111;
      background:rgba(255,255,255,.9); padding:4px 8px; border-radius:6px; z-index:1200;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    body.dark #status{ color:#eaeaea; background:rgba(0,0,0,.5); }
    #version{
      position:fixed; bottom:8px; right:10px; font:12px/1 monospace;
      color:rgba(255,255,255,.92); background:rgba(0,0,0,.6);
      padding:2px 6px; border-radius:4px; z-index:1200;
    }

    /* Settings menu */
    #settings{ margin-left:auto; position:relative; }
    #settingsBtn{ background:#fff; color:#111; }
    #settingsMenu{
      position:absolute; right:0; top:44px; min-width:260px;
      background:var(--panelBg); color:var(--panelText); border-radius:10px;
      box-shadow:0 12px 24px rgba(0,0,0,.2);
      display:none; overflow:hidden; z-index:1400; border:1px solid var(--border);
    }
    #settingsMenu button{
      display:block; width:100%; text-align:left; padding:10px 12px;
      border:0; background:transparent; cursor:pointer; color:var(--panelText);
    }
    #settingsMenu button:hover{ background:var(--chip); color:var(--panelText); }

    /* Modals */
    .modal{ position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(0,0,0,.45); z-index:1500; opacity:0; pointer-events:none; transition:opacity .18s ease; }
    .modal.show{ opacity:1; pointer-events:auto; }
    .card{
      width:min(560px, calc(100vw - 24px)); max-height:85vh; overflow:auto;
      background:var(--secondary); color:#111; border-radius:12px; box-shadow:var(--cardShadow);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      transform:translateY(6px); transition:transform .18s ease;
    }
    body.dark .card{ color:#eaeaea; }
    .modal.show .card{ transform:translateY(0); }
    .card header{ padding:12px 14px; background:var(--main); border-radius:12px 12px 0 0; font-weight:700; position:relative; color:var(--ink); }
    .card main{ padding:14px; display:grid; gap:12px; background:var(--accent); }
    .card footer{ padding:12px 14px; background:var(--secondary); border-radius:0 0 12px 12px; display:flex; gap:8px; justify-content:flex-end; }
    .modal .btn{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; }
    .btn.ghost{ background:#eee; color:#111; }
    body.dark .btn.ghost{ background:#2a2a2a; color:#eaeaea; }
    .row{ display:grid; gap:6px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    input[type="text"], input[type="url"], input[type="password"], select{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font:14px system-ui; background:#fff; color:#111;
    }
    body.dark input[type="text"], body.dark input[type="url"], body.dark input[type="password"], body.dark select{
      background:#111; color:#eaeaea; border-color:#333;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .link-row{ display:grid; grid-template-columns:1fr 2fr; gap:8px; align-items:center; }

    /* Popups */
    .leaflet-popup-content-wrapper{ background:var(--accent); border:2px solid var(--main); border-radius:10px; color:#111; }
    .leaflet-popup-tip{ background:var(--accent); }
    body.dark .leaflet-popup-content-wrapper{ color:#eaeaea; }
    .popup h3{
      margin:0 0 6px 0; font-size:16px; color:#111;
      background:var(--main); padding:4px 6px; border-radius:6px; display:inline-block;
    }
    body.dark .popup h3{ color:#fff; }
    .popup p{ margin:0 0 6px; }
    .popup small{ color:#333; display:block; margin-top:6px; }
    .popup a{ color:#003366; font-weight:600; text-decoration:none; border-bottom:1px solid transparent; }
    .popup a:hover{ border-bottom-color:#003366; }

    .area-label{
      background:rgba(255,255,255,.85);
      padding:2px 6px; border-radius:6px; font:12px/1.2 system-ui; color:#111;
      border:1px solid rgba(0,0,0,.1); white-space:nowrap; text-shadow:0 1px 0 rgba(255,255,255,.5);
    }

    /* Layers control */
    .leaflet-top.leaflet-left .leaflet-control.layers-toggle { margin:20px 0 0 10px; }
    .leaflet-control.layers-toggle .btn{
      display:flex; align-items:center; gap:6px;
      background:#fff; color:#111; border-radius:8px; padding:8px 10px;
      font:13px/1.2 system-ui; border:1px solid var(--border);
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .leaflet-control.layers-toggle .btn:hover{ background:#f7f7f7; }
    .leaflet-control.layers-toggle .panel{
      position:absolute; left:0; top:40px;
      background:var(--panelBg); color:var(--panelText); border-radius:10px; border:1px solid var(--border);
      box-shadow:0 12px 24px rgba(0,0,0,.2);
      padding:8px 10px; min-width:180px; display:none; max-height:40vh; overflow:auto;
    }
    .leaflet-control.layers-toggle .panel label{
      display:flex; align-items:center; gap:8px; padding:6px 4px; font:13px/1.2 system-ui;
    }

    /* Float cards: legend + stats (top-right stack) */
    .float-stack{ position:fixed; top:80px; right:10px; display:grid; gap:10px; z-index:900; pointer-events:none; }
    .float-card{
      background:var(--panelBg); color:var(--panelText); border:1px solid var(--border);
      border-radius:10px; box-shadow:0 12px 24px rgba(0,0,0,.2); overflow:hidden; min-width:220px; pointer-events:auto;
    }
    .float-card header{ padding:8px 10px; background:var(--chip); font-weight:700; display:flex; align-items:center; justify-content:space-between; }
    .float-card main{ padding:10px; display:grid; gap:8px; }
    .toggle-btn{ border:0; background:transparent; cursor:pointer; font-size:16px; line-height:1; color:inherit; }
    .legend-row{ display:flex; align-items:center; gap:8px; font:13px system-ui; }
    .legend-row img{ width:18px; height:18px; display:block; }

    /* Unlock Modal (inline password) */
    #unlockModal .card main{ background:var(--panelBg); }
    #unlockModal .card footer{ background:var(--secondary); }

    /* Toasts */
    #toasts{ position:fixed; inset:auto 0 16px 0; display:grid; place-items:center; gap:8px; z-index:1600; pointer-events:none; }
    .toast{
      background:var(--toastBg); color:var(--toastText); padding:10px 14px; border-radius:10px; font:14px system-ui;
      box-shadow:0 8px 24px rgba(0,0,0,.25); transform:translateY(20px); opacity:0; transition:.2s ease;
      pointer-events:auto;
    }
    .toast.show{ transform:translateY(0); opacity:1; }
    .toast.error{ background:#b00020; }
    .toast.success{ background:#1b5e20; }

    /* Map zoom control lift */
    .leaflet-bottom.leaflet-left .leaflet-control-zoom{ margin: 0 0 32px 10px; }

    /* EDIT/DELETE visibility controller */
    body.no-edit .popup-actions{ display:none !important; }
  </style>
</head>
<body class="no-edit">
  <div id="toolbar">
    <div id="brand">
      <img src="Dynasty8-GTAV-Logo.png" alt="Dynasty 8">
      <strong>Property Map</strong>
    </div>

    <!-- Hidden until unlocked -->
    <label id="addWrap" style="display:none" title="Enable click-to-add mode"><input type="checkbox" id="addMode"> Add</label>
    <label id="editWrap" style="display:none" title="Enable drag/edit mode"><input type="checkbox" id="editMode"> Edit</label>

    <button id="unlockBtn" title="Enter password to edit">Unlock</button>
    <button id="lockBtn" style="display:none" title="Lock editing">Lock</button>

    <span id="hint">Syncing‚Ä¶</span>

    <div id="settings" style="margin-left:auto">
      <button id="settingsBtn" title="Open settings">‚öôÔ∏è Settings</button>
      <div id="settingsMenu" role="menu" aria-hidden="true">
        <button id="menuExport"      title="Download markers.json">Export markers</button>
        <button id="menuChangelog"   title="View recent commits">Changelog</button>
        <button id="menuStats"       title="Totals & last updated">Statistics</button>
        <button id="menuToggleAreas" title="Show/hide area names">Toggle area names</button>
        <button id="menuTheme"       title="Toggle light/dark theme">Toggle theme</button>
        <button id="menuLegend"      title="Show/hide legend">Toggle legend</button>
        <button id="menuMiniStats"   title="Show/hide mini-stats">Toggle mini-stats</button>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Float stack: Legend + Mini-stats -->
  <div class="float-stack">
    <section id="legendCard" class="float-card" style="display:none">
      <header>
        <span>Legend</span>
        <button class="toggle-btn" data-target="legendCard">‚Äì</button>
      </header>
      <main>
        <div class="legend-row"><img src="house-apartment.png" alt=""><span>Apartment</span></div>
        <div class="legend-row"><img src="house-penthouse.png" alt=""><span>Penthouse</span></div>
        <div class="legend-row"><img src="house-office.png" alt=""><span>Office</span></div>
        <div class="legend-row"><img src="house-motel.png" alt=""><span>Motel</span></div>
      </main>
    </section>

    <section id="miniStatsCard" class="float-card" style="display:none">
      <header>
        <span>Map Stats</span>
        <button class="toggle-btn" data-target="miniStatsCard">‚Äì</button>
      </header>
      <main id="miniStatsBody">
        <div>Total: ‚Äî</div>
        <div>Apartments: ‚Äî</div>
        <div>Penthouses: ‚Äî</div>
        <div>Offices: ‚Äî</div>
        <div>Motels: ‚Äî</div>
        <hr style="border:none;border-top:1px solid var(--border)">
        <div>Last updated: ‚Äî</div>
      </main>
    </section>
  </div>

  <div id="status">Loading map‚Ä¶</div>
  <div id="version"></div>

  <!-- Unlock Modal -->
  <div id="unlockModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="unlockTitle">
      <header id="unlockTitle">Unlock Editing</header>
      <main>
        <label class="row">
          <span>Password</span>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="pwInput" type="password" placeholder="Enter password‚Ä¶" autocomplete="current-password" />
            <button id="pwToggle" class="btn ghost" type="button" title="Show/Hide">üëÅÔ∏è</button>
          </div>
        </label>
        <label style="display:flex; align-items:center; gap:8px; font:13px system-ui;">
          <input id="rememberPw" type="checkbox" /> Remember for this session
        </label>
        <div class="muted">Editing requires anonymous sign-in and your Firebase rules to allow writes.</div>
      </main>
      <footer>
        <button id="pwCancel" class="btn ghost" type="button">Cancel</button>
        <button id="pwSubmit" class="btn primary" type="button">Unlock</button>
      </footer>
    </div>
  </div>

  <!-- Add Modal -->
  <div id="addModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Add Property</header>
    <main>
      <div class="row"><label><span>Name</span><input id="f-name" type="text" placeholder="e.g., Eclipse Towers Apt. 3"></label></div>
      <div class="grid-2">
        <label><span>Type</span>
          <select id="f-type">
            <option value="apartment" selected>Apartment</option>
            <option value="office">Office</option>
            <option value="motel">Motel</option>
            <option value="penthouse">Penthouse</option>
          </select>
        </label>
        <div class="row"><span class="muted">Type controls link fields.</span></div>
      </div>
      <div id="linksArea" class="row"></div>
      <div class="muted" id="coordsNote">Will be placed where you clicked.</div>
    </main>
    <footer><button id="btnCancel" class="btn ghost">Cancel</button><button id="btnSave" class="btn primary">Save</button></footer>
  </div></div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Edit Property</header>
    <main id="editBody"></main>
    <footer><button id="editCancel" class="btn ghost">Cancel</button><button id="editSave" class="btn primary">Save</button></footer>
  </div></div>

  <!-- Changelog Modal -->
  <div id="changelogModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Changelog <button id="chgCloseX" class="btn ghost" style="position:absolute;right:10px;top:8px">√ó</button></header>
    <main id="chgBody"><div style="padding:14px">Loading commits‚Ä¶</div></main>
    <footer><button id="chgClose" class="btn primary">Close</button></footer>
  </div></div>

  <!-- Stats Modal -->
  <div id="statsModal" class="modal" aria-hidden="true"><div class="card" role="dialog" aria-modal="true">
    <header>Statistics</header>
    <main id="statBody"></main>
    <footer><button id="statClose" class="btn primary">Close</button></footer>
  </div></div>

  <!-- Toasts -->
  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp,
      enableIndexedDbPersistence, getDocsFromCache, getDocsFromServer
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Build =====
    const VERSION = "beta 1.2.03";
    const VERSION_NOTE = "Fix: popup Edit/Delete wired on popupopen; removed brittle document-level delegation.";
    document.getElementById("version").textContent = VERSION;

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCcfOML9FD1Q5vcoCb3NdIlFKtx3LAovBc",
      authDomain: "dynasty8-property-map.firebaseapp.com",
      projectId: "dynasty8-property-map",
      storageBucket: "dynasty8-property-map.firebasestorage.app",
      messagingSenderId: "849316207524",
      appId: "1:849316207524:web:9c921ad842fc188d027f31",
      measurementId: "G-VXG629H337"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    try { await signInAnonymously(auth); } catch(e){ console.warn("[auth] anon failed:", e?.message||e); }
    try { await enableIndexedDbPersistence(db); } catch(e){ console.warn("[fs] persistence:", e?.message||e); }

    // ===== DOM =====
    const addModeEl  = document.getElementById("addMode");
    const editModeEl = document.getElementById("editMode");
    const addWrap    = document.getElementById("addWrap");
    const editWrap   = document.getElementById("editWrap");
    const unlockBtn  = document.getElementById("unlockBtn");
    const lockBtn    = document.getElementById("lockBtn");
    const hintEl     = document.getElementById("hint");
    const statusEl   = document.getElementById("status");
    const mapEl      = document.getElementById("map");
    const toastsEl   = document.getElementById("toasts");

    const settingsBtn   = document.getElementById("settingsBtn");
    const settingsMenu  = document.getElementById("settingsMenu");
    const menuExport    = document.getElementById("menuExport");
    const menuChangelog = document.getElementById("menuChangelog");
    const menuStats     = document.getElementById("menuStats");
    const menuToggleAreas = document.getElementById("menuToggleAreas");
    const menuTheme     = document.getElementById("menuTheme");
    const menuLegend    = document.getElementById("menuLegend");
    const menuMiniStats = document.getElementById("menuMiniStats");

    const chgModal  = document.getElementById("changelogModal");
    const chgBody   = document.getElementById("chgBody");
    const chgClose  = document.getElementById("chgClose");
    const chgCloseX = document.getElementById("chgCloseX");
    const statModal = document.getElementById("statsModal");
    const statBody  = document.getElementById("statBody");
    const statClose = document.getElementById("statClose");

    const addModal   = document.getElementById("addModal");
    const fName      = document.getElementById("f-name");
    const fType      = document.getElementById("f-type");
    const linksArea  = document.getElementById("linksArea");
    const btnCancel  = document.getElementById("btnCancel");
    const btnSave    = document.getElementById("btnSave");
    const coordsNote = document.getElementById("coordsNote");

    const editModal  = document.getElementById("editModal");
    const editBody   = document.getElementById("editBody");
    const editCancel = document.getElementById("editCancel");
    const editSave   = document.getElementById("editSave");
    let editingEntry = null;

    // === Mode toggles ===
addModeEl.addEventListener('change', () => {
  hint(addModeEl.checked ? 'Add mode ON' : 'Add mode OFF');
});

editModeEl.addEventListener('change', () => {
  applyEditMode();              // enable/disable dragging + show/hide popup actions
  // If a popup is open, refresh its buttons wiring
  const openPopup = document.querySelector('.leaflet-popup');
  if (openPopup) {
    // close/reopen to re-run popupopen wiring
    map.closePopup();
  }
});

    // Unlock modal
    const unlockModal = document.getElementById("unlockModal");
    const pwInput  = document.getElementById("pwInput");
    const pwToggle = document.getElementById("pwToggle");
    const rememberPw = document.getElementById("rememberPw");
    const pwCancel = document.getElementById("pwCancel");
    const pwSubmit = document.getElementById("pwSubmit");

    // Float cards
    const legendCard = document.getElementById("legendCard");
    const miniStatsCard = document.getElementById("miniStatsCard");
    const miniStatsBody = document.getElementById("miniStatsBody");

    // ===== State =====
    const LOCAL_EDIT_PASSWORD = "D8D8D8";
    const MAP_CANDIDATES = ["map.jpg","map.jpeg","map.png"];
    let unlocked = false;
    let map, currentIconSize = 32;
    let imageBounds = null;

    const groups = {
      apartment: L.layerGroup(), penthouse: L.layerGroup(),
      office: L.layerGroup(), motel: L.layerGroup()
    };
    const markers = new Map();
    let latestUpdatedAtMillis = 0;

    let zonesOverlay = null;
    const areaLabelsLayer = L.layerGroup();

    // ===== Toasts =====
    function toast(m, type="info", t=1800){
      const div = document.createElement("div");
      div.className = "toast " + (type==="error" ? "error" : (type==="success" ? "success" : ""));
      div.textContent = m;
      toastsEl.appendChild(div);
      requestAnimationFrame(()=> div.classList.add("show"));
      setTimeout(()=> {
        div.classList.remove("show");
        setTimeout(()=> div.remove(), 220);
      }, t);
    }
    const hint = (m)=>{ hintEl.textContent = m; };

    // ===== Theme Toggle =====
    function toggleTheme(){
      document.body.classList.toggle("dark");
      try { localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light"); } catch {}
    }
    try {
      const pref = localStorage.getItem("theme");
      if (pref === "dark") document.body.classList.add("dark");
    } catch {}

    // ===== Icons by type =====
    function iconFor(entry, size){
      const t = (entry.type || "apartment").toLowerCase();
      const files = {
        apartment: "house-apartment.png",
        penthouse: "house-penthouse.png",
        office:    "house-office.png",
        motel:     "house-motel.png"
      };
      const s = size || currentIconSize;
      return L.icon({ iconUrl: files[t] || files.apartment, iconSize:[s,s], iconAnchor:[s/2,s/2], tooltipAnchor:[0,-s/2] });
    }

    // ===== Link helpers =====
    function entryLinks(entry){
      if (entry?.links?.length) return entry.links;
      const arr = [];
      if (entry?.shabby) arr.push({ label:"Shabby Apartment", url:entry.shabby });
      if (entry?.nice)   arr.push({ label:"Nice Apartment",   url:entry.nice });
      return arr;
    }
    function renderLinksHTML(entry){
      const t = (entry.type || "apartment").toLowerCase();
      const links = entryLinks(entry);
      if (t === "apartment"){
        let shabby=null, nice=null;
        for (let i=0;i<links.length;i++){ if (!shabby && /shabby/i.test(links[i].label)) shabby=links[i]; if (!nice && /nice/i.test(links[i].label)) nice=links[i]; }
        return (shabby?`<p><a href="${shabby.url}" target="_blank" rel="noopener">Shabby Apartment</a></p>`:"") +
               (nice?  `<p><a href="${nice.url}"   target="_blank" rel="noopener">Nice Apartment</a></p>`  :"");
      }
      if (t === "office"){ const link = links[0]; return link?`<p><a href="${link.url}" target="_blank" rel="noopener">Office</a></p>`:""; }
      if (t === "motel"){
        const link = links[0];
        const note = '<div style="color:#d60000;font-weight:700;margin-top:6px">Don‚Äôt use this link in your listing, you need a door photo!</div>';
        return (link?`<p><a href="${link.url}" target="_blank" rel="noopener">Album</a></p>`:"")+note;
      }
      if (t === "penthouse"){
        let html=""; for (let j=0;j<links.length;j++){ const Lk=links[j]; html += `<p><a href="${Lk.url||''}" target="_blank" rel="noopener">${Lk.label||"Album"}</a></p>`; }
        return html;
      }
      let out=""; for (let k=0;k<links.length;k++){ const lk=links[k]; out += `<p><a href="${lk.url||''}" target="_blank" rel="noopener">${lk.label||"Link"}</a></p>`; }
      return out;
    }

    // ===== Marker popup / behavior (Always include actions) =====
    function setMarkerPopup(entry){
      const html =
        `<div class="popup">
          <h3>${entry.name || "Property"}</h3>
          <p><strong>Type:</strong> ${entry.type || "apartment"}</p>
          ${renderLinksHTML(entry)}
          <small>Coords: x=${entry.x.toFixed(1)}, y=${entry.y.toFixed(1)}</small>
          <div class="popup-actions" style="margin-top:6px;display:flex;gap:8px">
            <button class="btn" data-action="edit" data-id="${entry.id}" style="padding:4px 8px;background:var(--chip);border-radius:6px">Edit</button>
            <button class="btn" data-action="delete" data-id="${entry.id}" style="padding:4px 8px;background:var(--chip);border-radius:6px">Delete</button>
          </div>
        </div>`;

      if (entry._marker.getPopup && entry._marker.getPopup()) {
        entry._marker.getPopup().setContent(html);
      } else {
        entry._marker.bindPopup(html, { autoPan:false, keepInView:false });
      }

      // Basic pointer behavior
      entry._marker.off('mousedown').on('mousedown', (e)=>{ L.DomEvent.stopPropagation(e); });
      entry._marker.off('click').on('click', (e)=>{ L.DomEvent.stopPropagation(e); if (entry._marker.openPopup) entry._marker.openPopup(); });

      // Wire buttons every time the popup opens (reliable)
      entry._marker.off('popupopen').on('popupopen', (e) => {
        const el = e.popup?.getElement?.(); if (!el) return;
        const canEdit = unlocked && editModeEl.checked;

        const editBtn = el.querySelector('[data-action="edit"]');
        const delBtn  = el.querySelector('[data-action="delete"]');

        const wire = (btn, fn) => {
          if (!btn) return;
          btn.addEventListener('click', (ev) => {
            ev.preventDefault(); ev.stopPropagation();
            if (!canEdit) { toast("Enable Edit mode to use this.", "error"); return; }
            fn();
          }, { once:true }); // wire fresh each open
        };

        wire(editBtn, () => openEditModal(entry));
        wire(delBtn, async () => {
          if (!confirm('Delete this marker?')) return;
          try { await deleteDoc(doc(db, 'markers', entry.id)); toast('Deleted.', 'success'); }
          catch(err){ alert('Failed to delete: ' + (err?.message||err)); toast('Delete failed', 'error'); }
        });
      });
    }

   function applyEditMode(){
  const canEdit = unlocked && editModeEl.checked;
  console.log('[applyEditMode]', { unlocked, editChecked: editModeEl.checked, canEdit });
  document.body.classList.toggle('no-edit', !canEdit);
  markers.forEach(m => {
    if (m._marker) {
      if (canEdit && m._marker.dragging) m._marker.dragging.enable();
      else if (m._marker.dragging) m._marker.dragging.disable();
      setMarkerPopup(m);
    }
  });
  hint(canEdit ? "Edit mode ON" : (unlocked ? "Edit mode OFF" : "Locked (view-only)"));
}

    function setLockedUI(lock){
      unlocked = !lock;
      document.getElementById("unlockBtn").style.display = lock ? "" : "none";
      document.getElementById("lockBtn").style.display   = lock ? "none" : "";
      document.getElementById("addWrap").style.display   = lock ? "none" : "";
      document.getElementById("editWrap").style.display  = lock ? "none" : "";
      if (lock) editModeEl.checked = false;
      applyEditMode();
      hint(lock ? "Locked (view-only)" : "Edit unlocked");
    }

    // ===== Map init / Centering =====
    function init(imageUrl, w, h){
      imageBounds = L.latLngBounds([[0,0],[h,w]]);

      const mapInst = L.map("map", {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxZoom: 5,
        zoomControl: false,
        attributionControl: false
      });
      map = mapInst;

      L.control.zoom({ position: 'bottomleft' }).addTo(map);
      const imgLayer = L.imageOverlay(imageUrl, imageBounds, { interactive:false }).addTo(map);

      mapEl.style.display = "block";
      requestAnimationFrame(() => {
        map.invalidateSize();
        const targetZoom = map.getBoundsZoom(imageBounds, true);
        map.fitBounds(imageBounds, { paddingTopLeft:[0,160], padding:[16,16], maxZoom: targetZoom });
      });
      imgLayer.once('load', () => {
        const targetZoom = map.getBoundsZoom(imageBounds, true);
        map.fitBounds(imageBounds, { paddingTopLeft:[0,160], padding:[16,16], maxZoom: targetZoom });
      });

      statusEl.textContent = "Image map loaded";

      groups.apartment.addTo(map); groups.penthouse.addTo(map);
      groups.office.addTo(map); groups.motel.addTo(map);

      map.on("zoomend", () => {
        const z = map.getZoom();
        currentIconSize = Math.max(18, Math.min(48, Math.round((z+2)*4)));
        markers.forEach(m => { if (m._marker) m._marker.setIcon(iconFor(m)); });
      });

      map.on("click", (e) => {
        if (!(unlocked && addModeEl.checked)) return;
        if (document.querySelector("#addModal.show")) return;
        openAddModal(e.latlng);
      });

      addLayersControl();
      setLockedUI(true);
      tryLoadOverlay(true);
      tryLoadAreas();
      wireData();
    }

    function tryLoadImage(i=0){
      if (i >= MAP_CANDIDATES.length){
        statusEl.textContent = "Could not find map.jpg/jpeg/png next to index.html.";
        toast("Map image not found", "error");
        return;
      }
      const src = MAP_CANDIDATES[i] + "?v=" + Date.now();
      const img = new Image();
      img.onload = () => init(src, img.naturalWidth, img.naturalHeight);
      img.onerror = () => tryLoadImage(i+1);
      img.src = src;
    }

    // ===== Layers control (TOP-LEFT) =====
    function addLayersControl(){
      document.querySelectorAll('.leaflet-control.layers-toggle').forEach(n => n.remove());

      const LayersControl = L.Control.extend({
        position: 'topleft',
        onAdd: function(){
          const div = L.DomUtil.create('div', 'leaflet-control layers-toggle');
          const btn = L.DomUtil.create('button', 'btn', div);
          btn.type = 'button'; btn.title = 'Map layers'; btn.textContent = 'Layers';
          const panel = L.DomUtil.create('div', 'panel', div);
          panel.innerHTML = `
            <label><input type="checkbox" id="chkOverlay"> Zoning overlay</label>
            <label><input type="checkbox" id="chkAreas"> Area names</label>
          `;
          L.DomEvent.disableClickPropagation(div);
          L.DomEvent.on(btn, 'click', (ev) => {
            ev.preventDefault(); ev.stopPropagation();
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
          });
          L.DomEvent.on(map.getContainer(), 'click', () => { panel.style.display = 'none'; });
          setTimeout(() => {
            const chkOverlay = panel.querySelector('#chkOverlay');
            const chkAreas   = panel.querySelector('#chkAreas');
            chkOverlay.checked = !!(zonesOverlay && map.hasLayer(zonesOverlay));
            chkOverlay.addEventListener('change', () => {
              if (!zonesOverlay){ toast("No overlay found."); chkOverlay.checked = false; return; }
              if (chkOverlay.checked){ zonesOverlay.addTo(map); hint("Zones overlay shown"); }
              else { map.removeLayer(zonesOverlay); hint("Zones overlay hidden"); }
            });
            chkAreas.addEventListener('change', () => {
              if (chkAreas.checked){ areaLabelsLayer.addTo(map); hint("Area names shown"); }
              else { map.removeLayer(areaLabelsLayer); hint("Area names hidden"); }
            });
          }, 0);
          return div;
        }
      });
      const ctl = new LayersControl();
      map.addControl(ctl);
      const tl = map._controlCorners && map._controlCorners['topleft'];
      const el = document.querySelector('.leaflet-control.layers-toggle');
      if (tl && el && el.parentNode !== tl) tl.appendChild(el);
    }

    // ===== Overlay & Areas =====
    function tryLoadOverlay(defaultOn=false){
      const test = new Image();
      test.onload = () => {
        const bounds = imageBounds;
        zonesOverlay = L.imageOverlay("overlay.png?v="+Date.now(), bounds, { opacity:0.85, interactive:false });
        if (defaultOn) {
          zonesOverlay.addTo(map);
          const chk = document.getElementById("chkOverlay");
          if (chk) chk.checked = true;
        }
      };
      test.onerror = () => console.log("[zones] overlay.png not found (optional)");
      test.src = "overlay.png?v="+Date.now();
    }

    async function tryLoadAreas(){
      try {
        const res = await fetch("areas.json?v="+Date.now(), { cache:"no-store" });
        if (!res.ok) throw new Error(res.status);
        const areas = await res.json();
        if (!Array.isArray(areas)) throw new Error("areas.json must be an array");
        areaLabelsLayer.clearLayers();
        areas.forEach(a => {
          if (typeof a.x !== "number" || typeof a.y !== "number" || !a.name) return;
          const icon = L.divIcon({ className:"area-label", html: a.name, iconSize: null });
          L.marker([a.y, a.x], { icon, interactive:false }).addTo(areaLabelsLayer);
        });
      } catch (e){
        console.log("[areas] areas.json not found or invalid (optional)");
      }
    }

    // ===== Data (Firestore) =====
    const markersCol = collection(db, "markers");

    function layerFor(type){
      const t = (type || "apartment").toLowerCase();
      if (t === "penthouse") return groups.penthouse;
      if (t === "office")    return groups.office;
      if (t === "motel")     return groups.motel;
      return groups.apartment;
    }
    function createOrUpdateMarker(entry){
      let m = markers.get(entry.id);
      const t = (entry.type || "apartment").toLowerCase();
      if (!m){
        m = { ...entry };
        m._marker = L.marker([m.y, m.x], {
          draggable: !!(unlocked && editModeEl.checked),
          autoPan: false, keyboard:false, bubblingMouseEvents:false,
          icon: iconFor(m)
        }).bindTooltip(m.name || "Property", {direction:"top", offset:[0,-10]});
        m._marker.on('mousedown', (e)=>{ L.DomEvent.stopPropagation(e); });
        m._marker.on('click', (e)=>{ L.DomEvent.stopPropagation(e); if (m._marker.openPopup) m._marker.openPopup(); });

        layerFor(t).addLayer(m._marker);
        markers.set(entry.id, m);
        setMarkerPopup(m);
        m._marker.on('dragend', async (e) => {
          const pos = e.target.getLatLng();
          try{
            await updateDoc(doc(db, "markers", m.id), { y: pos.lat, x: pos.lng, updatedAt: serverTimestamp() });
            toast("Position saved", "success");
          }catch(err){ alert("Failed to save position: " + (err?.message||err)); toast("Save failed", "error"); }
        });
      } else {
        const oldType = (m.type || "apartment").toLowerCase();
        if (oldType !== t && m._marker){ layerFor(oldType).removeLayer(m._marker); layerFor(t).addLayer(m._marker); }
        m.name = entry.name; m.x = entry.x; m.y = entry.y; m.type = entry.type;
        m.links = entry.links; m.shabby = entry.shabby; m.nice = entry.nice; m.updatedAt = entry.updatedAt || m.updatedAt || 0;
        if (m._marker){
          m._marker.setLatLng([m.y, m.x]); m._marker.setIcon(iconFor(m));
          if (m._marker.setTooltipContent) m._marker.setTooltipContent(m.name || "Property");
          setMarkerPopup(m);
        }
      }
      if (m.updatedAt && m.updatedAt > latestUpdatedAtMillis) latestUpdatedAtMillis = m.updatedAt;
    }
    function removeMarker(id){
      const m = markers.get(id);
      if (m && m._marker){ layerFor(m.type).removeLayer(m._marker); }
      markers.delete(id);
    }

    async function wireData(){
      try {
        const cached = await getDocsFromCache(markersCol);
        if (!cached.empty){
          cached.forEach(d => pushDoc(d));
          statusEl.textContent = "Loaded " + markers.size + " properties (cache)";
          hint("Syncing‚Ä¶");
          map.fire("zoomend");
          updateMiniStats();
        }
      } catch {}

      if (markers.size === 0){
        try {
          const serverSnap = await getDocsFromServer(markersCol);
          if (!serverSnap.empty){
            serverSnap.forEach(d => pushDoc(d));
            statusEl.textContent = "Loaded " + markers.size + " properties (server)";
            hint("Ready");
            map.fire("zoomend");
            updateMiniStats();
          }
        } catch(e){ console.warn("[fs] server prefetch:", e?.message||e); }
      }

      onSnapshot(markersCol, {
        includeMetadataChanges: true,
        next: (snap) => {
          let changed=false;
          snap.docChanges().forEach(chg => {
            const d = chg.doc;
            if (chg.type==="removed"){ removeMarker(d.id); changed=true; return; }
            changed = pushDoc(d) || changed;
          });
          if (changed){
            statusEl.textContent = "Loaded " + markers.size + " properties";
            map.fire("zoomend");
            updateMiniStats();
          }
        },
        error: (err) => {
          console.error("[firestore] onSnapshot error:", err);
          statusEl.textContent = "Firestore error: " + (err?.message || err);
          hint("Check Firestore rules / auth");
          toast("Firestore error", "error");
        }
      });

      let readyFlipped = false;
      function flipReady(){ if (!readyFlipped){ hint("Ready"); readyFlipped = true; } }
      setTimeout(flipReady, 5000);
    }

    function pushDoc(d){
      const v = d.data()||{}; let ms=0;
      if (v.updatedAt){ try {
        if (typeof v.updatedAt.toDate === "function") ms = v.updatedAt.toDate().getTime();
        else if (v.updatedAt.seconds) ms = v.updatedAt.seconds*1000 + Math.floor((v.updatedAt.nanoseconds||0)/1e6);
      } catch{} }
      const entry = { id:d.id, name:v.name||"Property", x:v.x, y:v.y, type:v.type||"apartment",
        links:Array.isArray(v.links)?v.links:[], shabby:v.shabby||"", nice:v.nice||"", updatedAt:ms };
      const before = markers.has(entry.id);
      createOrUpdateMarker(entry);
      return !before || true;
    }

    // ===== Settings & unlock =====
    settingsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const open = settingsMenu.style.display === "block";
      settingsMenu.style.display = open ? "none" : "block";
    });
    document.addEventListener("click", () => { settingsMenu.style.display = "none"; });

    menuExport.addEventListener("click", () => {
      settingsMenu.style.display = "none";
      const arr = [];
      markers.forEach(m => {
        arr.push({ name:m.name, x:m.x, y:m.y, type:m.type, links:m.links, shabby:m.shabby, nice:m.nice });
      });
      const blob = new Blob([JSON.stringify(arr, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "markers.json";
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
      toast("Exported markers.json", "success");
    });

    document.getElementById("menuChangelog").addEventListener("click", () => { settingsMenu.style.display="none"; openChangelog(); });
    document.getElementById("chgClose").addEventListener("click", () => chgModal.classList.remove("show"));
    document.getElementById("chgCloseX").addEventListener("click", () => chgModal.classList.remove("show"));
    document.getElementById("menuStats").addEventListener("click", () => { settingsMenu.style.display="none"; renderStats(); statModal.classList.add("show"); });
    document.getElementById("statClose").addEventListener("click", () => { statModal.classList.remove("show"); });

    document.getElementById("menuToggleAreas").addEventListener("click", () => {
      settingsMenu.style.display = "none";
      if (map.hasLayer(areaLabelsLayer)) { map.removeLayer(areaLabelsLayer); hint("Area names hidden"); }
      else { areaLabelsLayer.addTo(map); hint("Area names shown"); }
    });
    menuTheme.addEventListener("click", () => { settingsMenu.style.display="none"; toggleTheme(); });
    menuLegend.addEventListener("click", () => { settingsMenu.style.display="none"; toggleCard(legendCard); });
    menuMiniStats.addEventListener("click", () => { settingsMenu.style.display="none"; toggleCard(miniStatsCard); });

    // Inline Unlock modal
    unlockBtn.addEventListener("click", () => {
      const remembered = sessionStorage.getItem("pw_ok")==="1";
      if (remembered) { setLockedUI(false); toast("Unlocked", "success"); return; }
      unlockModal.classList.add("show");
      pwInput.value = "";
      pwInput.type = "password";
      pwInput.focus();
    });
    lockBtn.addEventListener("click", async () => { try { await signOut(auth); } catch{} setLockedUI(true); toast("Locked"); });
    pwCancel.addEventListener("click", () => unlockModal.classList.remove("show"));
    pwToggle.addEventListener("click", () => { pwInput.type = (pwInput.type==="password"?"text":"password"); pwInput.focus(); });
    pwSubmit.addEventListener("click", () => handleUnlock());
    pwInput.addEventListener("keydown", (e)=>{ if (e.key==="Enter") handleUnlock(); });

    function handleUnlock(){
      const pass = pwInput.value.trim();
      if (pass !== LOCAL_EDIT_PASSWORD){ toast("Wrong password", "error"); return; }
      unlockModal.classList.remove("show");
      setLockedUI(false);
      toast("Unlocked", "success");
      if (rememberPw.checked){ try { sessionStorage.setItem("pw_ok","1"); } catch{} }
    }

    // ===== Changelog & Stats =====
    const REPO_OWNER = "equestrix"; const REPO_NAME  = "Apartment-Map";
    function escapeHtml(s){ const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}; return String(s).replace(/[&<>"]/g,c=>map[c]); }
    function openChangelog(){
      chgBody.innerHTML = '<div style="padding:14px">Loading commits‚Ä¶</div>';
      chgModal.classList.add("show");
      const cacheKey = "chg_" + REPO_OWNER + "_" + REPO_NAME;
      let cached=null; try { cached = sessionStorage.getItem(cacheKey); } catch {}
      if (cached){ chgBody.innerHTML = cached; return; }
      fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/commits?per_page=20`, { headers: { "Accept":"application/vnd.github+json" } })
        .then(res => { if (!res.ok) throw new Error("GitHub API "+res.status); return res.json(); })
        .then(commits => {
          let html="";
          for (const c of commits){
            const commit=c.commit||{}, authorObj=commit.author||null;
            const authorName = authorObj?.name || c.author?.login || "Unknown";
            const msg = (commit.message||"").trim(); const parts = msg.split(/\r?\n/);
            const title = parts.shift() || "Commit"; const body = parts.join("\n").trim();
            const dstr = authorObj?.date || commit.committer?.date || ""; let when="";
            try { when = dstr ? new Date(dstr).toLocaleString() : ""; } catch {}
            html += `<div class="commit" style="padding:12px 14px; border-bottom:1px solid var(--border)">
                      <h4 style="margin:0 0 6px; font-size:14px">${escapeHtml(title)}</h4>
                      ${ body ? `<div class="muted" style="white-space:pre-wrap">${escapeHtml(body)}</div>` : "" }
                      <small class="muted">${escapeHtml(authorName)} ‚Äî ${escapeHtml(when)}</small>
                     </div>`;
          }
          chgBody.innerHTML = html || '<div style="padding:14px">No recent commits.</div>';
          try { sessionStorage.setItem(cacheKey, chgBody.innerHTML); } catch {}
        })
        .catch(err => { chgBody.innerHTML = `<div style="padding:14px;color:#b00020">Failed to load commits: ${escapeHtml(err.message)}</div>`; });
    }

    function formatLastUpdated(ms){ if (!ms) return "‚Äî"; try { return new Date(ms).toLocaleString(); } catch{ return "‚Äî"; } }
    function gatherCounts(){
      const c = { total:0, apartment:0, penthouse:0, office:0, motel:0 };
      markers.forEach(m => { c.total++; const t=(m.type||"apartment").toLowerCase(); c[t] = (c[t]||0)+1; });
      return c;
    }
    function renderStats(){
      const counts = gatherCounts();
      const last = formatLastUpdated(latestUpdatedAtMillis);
      statBody.innerHTML =
        `<div style="padding:14px">
          <p><strong>Total properties:</strong> ${counts.total}</p>
          <p>Apartments: ${counts.apartment||0}</p>
          <p>Penthouses: ${counts.penthouse||0}</p>
          <p>Offices: ${counts.office||0}</p>
          <p>Motels: ${counts.motel||0}</p>
          <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
          <p><strong>Last updated:</strong> ${last}</p>
        </div>`;
    }
    function updateMiniStats(){
      if (!miniStatsCard || miniStatsCard.style.display==="none") return;
      const counts = gatherCounts();
      const last = formatLastUpdated(latestUpdatedAtMillis);
      miniStatsBody.innerHTML =
        `<div>Total: ${counts.total}</div>
         <div>Apartments: ${counts.apartment||0}</div>
         <div>Penthouses: ${counts.penthouse||0}</div>
         <div>Offices: ${counts.office||0}</div>
         <div>Motels: ${counts.motel||0}</div>
         <hr style="border:none;border-top:1px solid var(--border)">
         <div>Last updated: ${last}</div>`;
    }

    // Float card toggles + persistence
    function toggleCard(el){
      if (!el) return;
      const show = el.style.display === "none";
      el.style.display = show ? "block" : "none";
      if (show && el.id==="miniStatsCard") updateMiniStats();
      try{
        const s = JSON.parse(localStorage.getItem('ui_cards')||'{}');
        if (el.id==="legendCard") s.legend = show;
        if (el.id==="miniStatsCard") s.mini = show;
        localStorage.setItem('ui_cards', JSON.stringify(s));
      }catch{}
    }
    document.querySelectorAll('.toggle-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.getAttribute('data-target');
        const el = document.getElementById(id);
        toggleCard(el);
      });
    });
    try{
      const s = JSON.parse(localStorage.getItem('ui_cards')||'{}');
      if (s.legend!==undefined) legendCard.style.display = s.legend ? 'block' : 'none';
      if (s.mini!==undefined)   miniStatsCard.style.display = s.mini ? 'block' : 'none';
    }catch{}

    // ===== Add / Edit Modals =====
    let pendingLatLng = null;

    function renderLinkFields(type, entry){
      const t = (type||"apartment").toLowerCase();
      let html = "";
      if (t === "apartment"){
        const shabby = entry?.shabby || entryLinks(entry).find(l=>/shabby/i.test(l.label))?.url || "";
        const nice   = entry?.nice   || entryLinks(entry).find(l=>/nice/i.test(l.label))?.url   || "";
        html = `
          <div class="link-row"><label>Shabby</label><input id="f-shabby" type="url" placeholder="https://imgur.com/a/..." value="${shabby}"></div>
          <div class="link-row"><label>Nice</label><input id="f-nice" type="url" placeholder="https://imgur.com/a/..." value="${nice}"></div>
        `;
      } else if (t === "office" || t === "motel"){
        const url = (entry?.links?.[0]?.url) || "";
        const label = (t === "office") ? "Office" : "Album";
        html = `<div class="link-row"><label>${label}</label><input id="f-single" type="url" placeholder="https://imgur.com/a/..." value="${url}"></div>`;
      } else { // penthouse (1‚Äì8)
        const links = Array.isArray(entry?.links) ? entry.links : [];
        const count = Math.max(links.length, 2);
        let rows = "";
        for (let i=0;i<Math.min(Math.max(count,2),8);i++){
          const Lk = links[i] || { label:"Album "+(i+1), url:"" };
          rows += `
            <div class="grid-2">
              <input class="ph-label" data-i="${i}" type="text" placeholder="Album ${i+1} title" value="${Lk.label||""}">
              <input class="ph-url"   data-i="${i}" type="url"  placeholder="https://imgur.com/a/..." value="${Lk.url||""}">
            </div>`;
        }
        html = rows + `<div class="muted">You can add more rows later by editing.</div>`;
      }
      linksArea.innerHTML = html;
    }

    function openAddModal(latlng){
      pendingLatLng = latlng;
      fName.value = "";
      fType.value = "apartment";
      renderLinkFields("apartment", null);
      coordsNote.textContent = `Will be placed at x=${latlng.lng.toFixed(1)}, y=${latlng.lat.toFixed(1)}.`;
      addModal.classList.add("show");
    }
    function closeAddModal(){ addModal.classList.remove("show"); pendingLatLng = null; }
    fType.addEventListener("change", () => renderLinkFields(fType.value, null));
    btnCancel.addEventListener("click", () => closeAddModal());
    btnSave.addEventListener("click", async () => {
      if (!pendingLatLng) return;
      const { lat, lng } = pendingLatLng;
      const name = (fName.value||"").trim();
      const type = fType.value;
      if (!name){ alert("Name is required."); return; }

      let links = [], shabby="", nice="";
      if (type === "apartment"){
        shabby = document.getElementById("f-shabby").value.trim();
        nice   = document.getElementById("f-nice").value.trim();
      } else if (type === "office" || type === "motel"){
        const url = document.getElementById("f-single").value.trim();
        if (url) links.push({ label: type==="office" ? "Office" : "Album", url });
      } else {
        const lbls = Array.from(addModal.querySelectorAll(".ph-label"));
        const urls = Array.from(addModal.querySelectorAll(".ph-url"));
        for (let i=0;i<Math.min(lbls.length, urls.length);i++){
          const label=(lbls[i].value||"").trim(), url=(urls[i].value||"").trim();
          if (url) links.push({ label: label||("Album "+(i+1)), url });
        }
      }

      try{
        await addDoc(collection(db,"markers"), {
          name, type, links, x: lng, y: lat,
          shabby: (type==="apartment") ? (shabby||"") : "",
          nice:   (type==="apartment") ? (nice  ||"") : "",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        closeAddModal(); toast("Property added.", "success");
      }catch(err){
        console.error("[add] failed:", err);
        alert("Failed to add property: " + (err?.message || err));
        toast("Add failed", "error");
      }
    });

    // Edit modal
    function openEditModal(entry){
      editingEntry = entry;
      const lks = entryLinks(entry);
      const t = (entry.type||"apartment").toLowerCase();
      let html = `
        <div class="row"><label><span>Name</span>
          <input id="e-name" type="text" value="${(entry.name||"").replace(/"/g,'&quot;')}"></label></div>
        <div class="row"><label><span>Type</span>
          <select id="e-type">
            <option value="apartment"${t==="apartment"?" selected":""}>Apartment</option>
            <option value="office"${t==="office"?" selected":""}>Office</option>
            <option value="motel"${t==="motel"?" selected":""}>Motel</option>
            <option value="penthouse"${t==="penthouse"?" selected":""}>Penthouse</option>
          </select></label></div>
      `;
      if (t === "apartment"){
        let shabby = entry.shabby || lks.find(x=>/shabby/i.test(x.label))?.url || "";
        let nice   = entry.nice   || lks.find(x=>/nice/i.test(x.label))?.url   || "";
        html += `
          <div class="link-row"><label>Shabby</label><input id="e-shabby" type="url" value="${shabby}"></div>
          <div class="link-row"><label>Nice</label><input id="e-nice" type="url" value="${nice}"></div>
        `;
      } else if (t === "office" || t === "motel"){
        const url = (lks[0]?.url)||"";
        const label = (t==="office")?"Office":"Album";
        html += `<div class="link-row"><label>${label}</label><input id="e-single" type="url" value="${url}"></div>`;
      } else {
        const rows = (lks.length ? lks : [{label:"Album 1",url:""},{label:"Album 2",url:""}])
          .slice(0,8)
          .map((Lk,i)=>`
            <div class="grid-2">
              <input class="pe-label" data-i="${i}" type="text" placeholder="Album ${i+1} title" value="${(Lk.label||"").replace(/"/g,'&quot;')}">
              <input class="pe-url"   data-i="${i}" type="url"  placeholder="https://imgur.com/a/..." value="${(Lk.url||"").replace(/"/g,'&quot;')}">
            </div>`).join("");
        html += rows;
      }
      html += `<div class="muted">Drag the marker to move it while Edit mode is on.</div>`;
      editBody.innerHTML = html;
      editModal.classList.add("show");
    }
    editCancel.addEventListener("click", () => { editModal.classList.remove("show"); editingEntry=null; });
    editSave.addEventListener("click", async () => {
      if (!editingEntry) return;
      const name = (document.getElementById("e-name").value||"").trim();
      const type = (document.getElementById("e-type").value||"apartment").toLowerCase();

      let links = [], shabby="", nice="";
      if (type === "apartment"){
        shabby = (document.getElementById("e-shabby").value||"").trim();
        nice   = (document.getElementById("e-nice").value||"").trim();
      } else if (type === "office" || type === "motel"){
        const url = (document.getElementById("e-single").value||"").trim();
        if (url) links.push({ label: type==="office" ? "Office" : "Album", url });
      } else {
        const lbls = Array.from(editModal.querySelectorAll(".pe-label"));
        const urls = Array.from(editModal.querySelectorAll(".pe-url"));
        for (let i=0;i<Math.min(lbls.length, urls.length);i++){
          const label=(lbls[i].value||"").trim(), url=(urls[i].value||"").trim();
          if (url) links.push({ label: label||("Album "+(i+1)), url });
        }
      }

      try{
        await updateDoc(doc(db,"markers",editingEntry.id),{
          name, type, links,
          shabby: (type==="apartment") ? (shabby||"") : "",
          nice:   (type==="apartment") ? (nice  ||"") : "",
          updatedAt: serverTimestamp()
        });
        editModal.classList.remove("show"); editingEntry=null;
        toast("Changes saved", "success");
      }catch(err){
        console.error("[edit] failed:", err);
        alert("Failed to save changes: " + (err?.message||err));
        toast("Save failed", "error");
      }
    });

    // Shortcuts & modal UX
    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      [unlockModal, addModal, editModal, chgModal, statModal].forEach(m => {
        if (m && m.classList.contains('show')) m.classList.remove('show');
      });
    });
    document.querySelectorAll('.modal').forEach(modal=>{
      modal.addEventListener('click', (e)=>{
        if (e.target === modal) modal.classList.remove('show');
      });
    });

    // ===== Boot =====
    document.getElementById("menuLegend").click();     // legend default ON
    // document.getElementById("menuMiniStats").click(); // mini-stats default OFF
    tryLoadImage();

  </script>
</body>
</html>
