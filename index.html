<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Property Map — beta 2.0.3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin
  />
  <style>
    :root {
      --main: #93c47d;
      --secondary: #b6d7a8;
      --accent: #d9ead3;
      --sea: #0fa8d2;
      --ink: #111;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--sea);
    }
    .leaflet-container {
      background: var(--sea);
    }
    #map {
      position: absolute;
      inset: 56px 0 0 0;
      display: none;
    }
    #toolbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: var(--main);
      color: var(--ink);
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #toolbar button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      background: #fff;
      color: #111;
      font-weight: 700;
    }
    #toolbar label {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #toolbar input[type="checkbox"] {
      transform: translateY(1px);
    }
    #status {
      position: fixed;
      bottom: 8px;
      left: 10px;
      font: 13px/1.3 system-ui;
      color: #111;
      background: rgba(255,255,255,0.9);
      padding: 4px 8px;
      border-radius: 6px;
      z-index: 1200;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    #version {
      position: fixed;
      bottom: 8px;
      right: 10px;
      font: 12px/1 monospace;
      color: rgba(255,255,255,0.92);
      background: rgba(0,0,0,0.6);
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 1200;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.45);
      z-index: 1500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease;
    }
    .modal.show {
      opacity: 1;
      pointer-events: auto;
    }
    .card {
      width: min(560px, calc(100vw - 24px));
      max-height: 85vh;
      overflow: auto;
      background: var(--secondary);
      color: #111;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      transform: translateY(6px);
      transition: transform 0.18s ease;
    }
    .modal.show .card {
      transform: translateY(0);
    }
    .card header {
      padding: 12px 14px;
      background: var(--main);
      border-radius: 12px 12px 0 0;
      font-weight: 700;
    }
    .card main {
      padding: 14px;
      display: grid;
      gap: 12px;
      background: var(--accent);
    }
    .card footer {
      padding: 12px 14px;
      background: var(--secondary);
      border-radius: 0 0 12px 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .btn {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn.primary {
      background: #111;
      color: #fff;
    }
    .btn.ghost {
      background: #eee;
      color: #111;
    }
    .row {
      display: grid;
      gap: 6px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    input[type="text"], input[type="url"], select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font: 14px system-ui;
      background: #fff;
      color: #111;
    }
    .muted {
      color: #333;
      font-size: 12px;
    }
    .link-row {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 8px;
      align-items: center;
    }
    .leaflet-popup-content-wrapper {
      background: var(--accent);
      border: 2px solid var(--main);
      border-radius: 10px;
    }
    .leaflet-popup-tip {
      background: var(--accent);
    }
    .popup h3 {
      margin: 0 0 6px 0;
      font-size: 16px;
      color: #111;
      background: var(--main);
      padding: 4px 6px;
      border-radius: 6px;
      display: inline-block;
    }
    .popup p {
      margin: 0 0 6px;
    }
    .popup small {
      color: #333;
      display: block;
      margin-top: 6px;
    }
    .popup a {
      color: #003366;
      font-weight: 600;
      text-decoration: none;
      border-bottom: 1px solid transparent;
    }
    .popup a:hover {
      border-bottom-color: #003366;
    }
    .area-label {
      background: rgba(255,255,255,0.85);
      padding: 2px 6px;
      border-radius: 6px;
      font: 12px/1.2 system-ui;
      color: #111;
      border: 1px solid rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    .leaflet-top.leaflet-left .leaflet-control.layers-toggle {
      margin: 118px 0 0 10px;
    }
  </style>
</head>

<body>
  <div id="toolbar">
    <div id="brand"><strong>Property Map</strong></div>
    <label id="addWrap" style="display:none"><input type="checkbox" id="addMode"> Add</label>
    <label id="editWrap" style="display:none"><input type="checkbox" id="editMode"> Edit</label>
    <button id="unlockBtn">Unlock</button>
    <button id="lockBtn" style="display:none">Lock</button>
    <span id="hint">Syncing…</span>
    <div id="settings" style="margin-left:auto">
      <button id="settingsBtn">⚙️</button>
      <div id="settingsMenu" style="display:none">
        <button id="menuExport">Export</button>
        <button id="menuChangelog">Changelog</button>
        <button id="menuStats">Stats</button>
        <button id="menuToggleAreas">Toggle Areas</button>
      </div>
    </div>
  </div>

  <div id="map"></div>
  <div id="status">Loading map…</div>
  <div id="version">beta 2.0.3</div>

  <!-- Add Modal -->
  <div id="addModal" class="modal"><div class="card">
    <header>Add Property</header>
    <main>
      <div class="row"><label>Name <input id="f-name" type="text"></label></div>
      <div class="grid-2">
        <label>Type <select id="f-type">
            <option value="apartment">Apartment</option>
            <option value="office">Office</option>
            <option value="motel">Motel</option>
            <option value="penthouse">Penthouse</option>
        </select></label>
        <div class="row"><span class="muted">link fields</span></div>
      </div>
      <div id="linksArea"></div>
      <div class="muted" id="coordsNote"></div>
    </main>
    <footer>
      <button id="btnCancel" class="btn ghost">Cancel</button>
      <button id="btnSave" class="btn primary">Save</button>
    </footer>
  </div></div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal"><div class="card">
    <header>Edit Property</header>
    <main id="editBody"></main>
    <footer>
      <button id="editCancel" class="btn ghost">Cancel</button>
      <button id="editSave" class="btn primary">Save</button>
    </footer>
  </div></div>

  <!-- Changelog / Stats -->
  <div id="changelogModal" class="modal"><div class="card">
    <header>Changelog <button id="chgCloseX" class="btn ghost" style="position:absolute;right:10px;top:8px">×</button></header>
    <main id="chgBody"></main>
    <footer><button id="chgClose" class="btn primary">Close</button></footer>
  </div></div>

  <div id="statsModal" class="modal"><div class="card">
    <header>Statistics</header>
    <main id="statBody"></main>
    <footer><button id="statClose" class="btn primary">Close</button></footer>
  </div></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp,
      enableIndexedDbPersistence, getDocsFromCache
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Version & changelog
    const VERSION = "beta 2.0.3";
    const CHANGELOG = [
      "Fix: popup on marker click now works reliably",
      "Fix: marker data loading reliably from Firestore",
      "Refactor: event binding cleaned up for popups",
      "Feature: version + changelog baked into UI"
    ];

    document.getElementById("version").textContent = VERSION;

    // Firebase setup
    const firebaseConfig = {
      apiKey: "AIzaSyCcfOML9FD1Q5vcoCb3NdIlFKtx3LAovBc",
      authDomain: "dynasty8-property-map.firebaseapp.com",
      projectId: "dynasty8-property-map",
      storageBucket: "dynasty8-property-map.firebasestorage.app",
      messagingSenderId: "849316207524",
      appId: "1:849316207524:web:9c921ad842fc188d027f31",
      measurementId: "G-VXG629H337"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { await signInAnonymously(auth); } catch(e) { console.warn("Auth failed:", e); }
    try { await enableIndexedDbPersistence(db); } catch(e) { console.warn("Persistence failed:", e); }

    // DOM & state
    const addModeEl = document.getElementById("addMode");
    const editModeEl = document.getElementById("editMode");
    const addWrap = document.getElementById("addWrap");
    const editWrap = document.getElementById("editWrap");
    const unlockBtn = document.getElementById("unlockBtn");
    const lockBtn = document.getElementById("lockBtn");
    const hintEl = document.getElementById("hint");
    const statusEl = document.getElementById("status");
    const mapEl = document.getElementById("map");

    const settingsBtn = document.getElementById("settingsBtn");
    const settingsMenu = document.getElementById("settingsMenu");
    const menuExport = document.getElementById("menuExport");
    const menuChangelog = document.getElementById("menuChangelog");
    const menuStats = document.getElementById("menuStats");
    const menuToggleAreas = document.getElementById("menuToggleAreas");

    const chgModal = document.getElementById("changelogModal");
    const chgBody = document.getElementById("chgBody");
    const chgClose = document.getElementById("chgClose");
    const chgCloseX = document.getElementById("chgCloseX");

    const statModal = document.getElementById("statsModal");
    const statBody = document.getElementById("statBody");
    const statClose = document.getElementById("statClose");

    const addModal = document.getElementById("addModal");
    const fName = document.getElementById("f-name");
    const fType = document.getElementById("f-type");
    const linksArea = document.getElementById("linksArea");
    const btnCancel = document.getElementById("btnCancel");
    const btnSave = document.getElementById("btnSave");
    const coordsNote = document.getElementById("coordsNote");

    const editModal = document.getElementById("editModal");
    const editBody = document.getElementById("editBody");
    const editCancel = document.getElementById("editCancel");
    const editSave = document.getElementById("editSave");

    let map, imageBounds;
    let unlocked = false;
    let currentIconSize = 32;

    const groups = {
      apartment: L.layerGroup(),
      penthouse: L.layerGroup(),
      office: L.layerGroup(),
      motel: L.layerGroup()
    };
    const markers = new Map();
    let zonesOverlay = null;
    const areaLabels = L.layerGroup();

    const markersCol = collection(db, "markers");

    // Utility / helper functions

    function toast(msg) {
      hintEl.textContent = msg;
    }

    function iconForType(type) {
      const mapIcon = {
        apartment: "house-apartment.png",
        penthouse: "house-penthous e.png", // **Oops, fix typo** — make sure your asset name is correct
        office: "house-office.png",
        motel: "house-motel.png"
      };
      const url = mapIcon[type] || mapIcon.apartment;
      return L.icon({
        iconUrl: url,
        iconSize: [currentIconSize, currentIconSize],
        iconAnchor: [currentIconSize / 2, currentIconSize / 2],
        tooltipAnchor: [0, -currentIconSize / 2]
      });
    }

    function entryLinks(entry) {
      if (Array.isArray(entry.links)) {
        return entry.links;
      }
      const arr = [];
      if (entry.shabby) arr.push({ label: "Shabby", url: entry.shabby });
      if (entry.nice) arr.push({ label: "Nice", url: entry.nice });
      return arr;
    }

    function renderLinksHTML(entry) {
      const links = entryLinks(entry);
      if (entry.type === "apartment") {
        const shabby = links.find(l => /shabby/i.test(l.label));
        const nice = links.find(l => /nice/i.test(l.label));
        return (shabby ? `<p><a href="${shabby.url}" target="_blank">Shabby</a></p>` : "") +
               (nice   ? `<p><a href="${nice.url}"   target="_blank">Nice</a></p>` : "");
      }
      return links.map(l => `<p><a href="${l.url}" target="_blank">${l.label}</a></p>`).join("");
    }

    function buildPopupHTML(entry) {
      return `
        <div class="popup">
          <h3>${entry.name}</h3>
          <p><strong>Type:</strong> ${entry.type}</p>
          ${renderLinksHTML(entry)}
          <small>Coords x=${entry.x.toFixed(1)}, y=${entry.y.toFixed(1)}</small>
        </div>
      `;
    }

    function attachEditDelete(popupEl, entry) {
      const btnEdit = popupEl.querySelector("[data-action=edit]");
      const btnDel = popupEl.querySelector("[data-action=delete]");
      if (btnEdit) {
        btnEdit.addEventListener("click", e => {
          e.stopPropagation();
          openEditModal(entry);
        });
      }
      if (btnDel) {
        btnDel.addEventListener("click", e => {
          e.stopPropagation();
          if (confirm("Delete this property?")) {
            deleteDoc(doc(db, "markers", entry.id))
              .catch(err => alert("Delete failed: " + err.message));
          }
        });
      }
    }

    function createOrUpdateMarker(entry) {
      if (!entry || typeof entry.x !== "number" || typeof entry.y !== "number") {
        console.warn("Invalid entry, skipping:", entry);
        return;
      }
      let rec = markers.get(entry.id);
      const type = entry.type || "apartment";
      if (!rec) {
        const marker = L.marker([entry.y, entry.x], {
          draggable: false,
          icon: iconForType(type),
          autoPan: false
        });
        marker.bindPopup(buildPopupHTML(entry));
        marker.bindTooltip(entry.name || "Property", { direction:"top", offset:[0,-10] });

        marker.on("mousedown", e => L.DomEvent.stopPropagation(e));
        marker.on("click", e => {
          marker.openPopup();
        });
        marker.on("popupopen", e => {
          const container = e.popup.getElement();
          if (unlocked && editModeEl.checked && container) {
            container
              .querySelector(".popup h3")
              .insertAdjacentHTML("afterend", `
                <div style="margin-top:6px;display:flex;gap:8px">
                  <button class="btn" data-action="edit">Edit</button>
                  <button class="btn" data-action="delete">Delete</button>
                </div>
              `);
            attachEditDelete(container, entry);
          }
        });
        marker.on("dragend", e => {
          const latlng = e.target.getLatLng();
          updateDoc(doc(db, "markers", entry.id), {
            x: latlng.lng,
            y: latlng.lat,
            updatedAt: serverTimestamp()
          }).catch(err => {
            alert("Save position failed: " + err.message);
          });
        });

        const layer = groups[type] || groups.apartment;
        layer.addLayer(marker);

        rec = { entry, marker };
        markers.set(entry.id, rec);
      } else {
        rec.entry = entry;
        rec.marker.setLatLng([entry.y, entry.x]);
        rec.marker.setIcon(iconForType(type));
        rec.marker.setPopupContent(buildPopupHTML(entry));
        rec.marker.getTooltip().setContent(entry.name);
      }

      if (rec.marker.dragging) {
        if (unlocked && editModeEl.checked) rec.marker.dragging.enable();
        else rec.marker.dragging.disable();
      }
    }

    function removeMarker(id) {
      const rec = markers.get(id);
      if (rec) {
        const type = rec.entry.type;
        const layer = groups[type] || groups.apartment;
        layer.removeLayer(rec.marker);
        markers.delete(id);
      }
    }

    function pushDoc(docSnap) {
      if (!docSnap.exists()) return;
      const v = docSnap.data();
      const entry = {
        id: docSnap.id,
        name: v.name || "Property",
        x: v.x,
        y: v.y,
        type: v.type || "apartment",
        links: v.links || [],
        shabby: v.shabby || "",
        nice: v.nice || ""
      };
      createOrUpdateMarker(entry);
    }

    function wireFirestore() {
      getDocsFromCache(markersCol)
        .then(snap => {
          snap.forEach(d => pushDoc(d));
          statusEl.textContent = `Loaded ${markers.size} (cache)`;
        })
        .catch(e => console.warn("Cache load error:", e))
        .finally(() => {
          onSnapshot(markersCol, snap => {
            snap.docChanges().forEach(chg => {
              if (chg.type === "removed") removeMarker(chg.doc.id);
              else pushDoc(chg.doc);
            });
            statusEl.textContent = `Loaded ${markers.size} entries`;
            toast("Ready");
          }, err => {
            console.error("Snapshot error:", err);
            statusEl.textContent = "Firestore error";
          });
        });
    }

    function setLockedUI(lock) {
      unlocked = !lock;
      unlockBtn.style.display = lock ? "" : "none";
      lockBtn.style.display = lock ? "none" : "";
      addWrap.style.display = lock ? "none" : "";
      editWrap.style.display = lock ? "none" : "";
      if (lock) editModeEl.checked = false;
      toggleDragging();
      toast(lock ? "Locked" : "Unlocked");
    }

    function toggleDragging() {
      markers.forEach(rec => {
        if (rec.marker.dragging) {
          if (unlocked && editModeEl.checked) rec.marker.dragging.enable();
          else rec.marker.dragging.disable();
        }
      });
    }

    function initMap(imgUrl, w, h) {
      const bounds = L.latLngBounds([[0,0],[h,w]]);
      imageBounds = bounds;
      map = L.map("map", {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxZoom: 5,
        zoomControl: false,
        attributionControl: false
      });
      L.control.zoom({ position: "bottomleft" }).addTo(map);
      L.imageOverlay(imgUrl, bounds).addTo(map);
      mapEl.style.display = "block";
      requestAnimationFrame(() => {
        map.invalidateSize();
        const z = map.getBoundsZoom(bounds, true);
        map.setView(bounds.getCenter(), z, { animate: false });
        map.panBy([0, 160], { animate: false });
      });

      Object.values(groups).forEach(g => g.addTo(map));
      map.on("zoomend", () => {
        const z = map.getZoom();
        currentIconSize = Math.max(16, Math.min(48, z * 4));
        markers.forEach(rec => rec.marker.setIcon(iconForType(rec.entry.type)));
      });

      map.on("click", e => {
        if (unlocked && addModeEl.checked && !document.querySelector(".modal.show")) {
          openAddModal(e.latlng);
        }
      });

      addLayerControl();
      loadOverlay();
      loadAreas();
      setLockedUI(true);
      wireFirestore();
    }

    function tryLoadImage(idx = 0) {
      const candidates = ["map.jpg","map.jpeg","map.png"];
      if (idx >= candidates.length) {
        statusEl.textContent = "Map not found";
        return;
      }
      const src = candidates[idx] + `?v=${Date.now()}`;
      const img = new Image();
      img.onload = () => initMap(src, img.naturalWidth, img.naturalHeight);
      img.onerror = () => tryLoadImage(idx + 1);
      img.src = src;
    }

    function addLayerControl() {
      const Layers = L.Control.extend({
        onAdd: () => {
          const div = L.DomUtil.create("div", "leaflet-control layers-toggle");
          const btn = L.DomUtil.create("button", "", div);
          btn.textContent = "Layers";
          const panel = L.DomUtil.create("div", "panel", div);
          panel.innerHTML = `
            <label><input type="checkbox" id="chkOverlay"> Zoning</label>
            <label><input type="checkbox" id="chkAreas"> Areas</label>
          `;
          L.DomEvent.disableClickPropagation(div);
          btn.addEventListener("click", () => {
            panel.style.display = panel.style.display === "block" ? "none" : "block";
          });
          map.getContainer().addEventListener("click", () => panel.style.display = "none");
          setTimeout(() => {
            const chk = panel.querySelector("#chkOverlay");
            const chkA = panel.querySelector("#chkAreas");
            chk.addEventListener("change", () => {
              zonesOverlay
                ? (chk.checked ? zonesOverlay.addTo(map) : map.removeLayer(zonesOverlay))
                : toast("No overlay");
            });
            chkA.addEventListener("change", () => {
              chkA.checked ? areaLabels.addTo(map) : map.removeLayer(areaLabels);
            });
          }, 0);
          return div;
        }
      });
      map.addControl(new Layers({ position: "topleft" }));
    }

    function loadOverlay() {
      const img = new Image();
      img.onload = () => {
        zonesOverlay = L.imageOverlay("overlay.png?v="+Date.now(), imageBounds, { opacity: 0.85 });
        zonesOverlay.addTo(map);
      };
      img.src = "overlay.png?v="+Date.now();
    }

    async function loadAreas() {
      try {
        const res = await fetch("areas.json?v="+Date.now(), { cache: "no-store" });
        const arr = await res.json();
        arr.forEach(a => {
          if (typeof a.x === "number" && typeof a.y === "number" && a.name) {
            const icon = L.divIcon({ className:"area-label", html: a.name });
            L.marker([a.y, a.x], { icon, interactive:false }).addTo(areaLabels);
          }
        });
        areaLabels.addTo(map);
      } catch(e) {
        console.warn("Load areas error:", e);
      }
    }

    // Add / Edit UI

    let pendingLatLng = null;
    let editingEntry = null;

    function renderLinkFields(type, entry = {}) {
      let html = "";
      if (type === "apartment") {
        html = `
          <div class="link-row"><label>Shabby</label><input id="f-shabby" type="url" value="${entry.shabby || ""}"></div>
          <div class="link-row"><label>Nice</label><input id="f-nice" type="url" value="${entry.nice || ""}"></div>
        `;
      } else if (type === "office" || type === "motel") {
        const url = (entry.links?.[0]?.url) || "";
        html = `<div class="link-row"><label>${type === "office" ? "Office" : "Album"}</label><input id="f-single" type="url" value="${url}"></div>`;
      } else {
        const links = entry.links || [];
        for (let i = 0; i < Math.max(links.length, 2); i++) {
          const lk = links[i] || { label:`Album${i+1}`, url:"" };
          html += `
            <div class="grid-2">
              <input class="ph-label" data-i="${i}" type="text" value="${lk.label}">
              <input class="ph-url"   data-i="${i}" type="url" value="${lk.url}">
            </div>
          `;
        }
      }
      linksArea.innerHTML = html;
    }

    function openAddModal(latlng) {
      pendingLatLng = latlng;
      fName.value = "";
      fType.value = "apartment";
      renderLinkFields("apartment");
      coordsNote.textContent = `Will place x=${latlng.lng.toFixed(1)}, y=${latlng.lat.toFixed(1)}`;
      addModal.classList.add("show");
    }
    function closeAddModal() {
      addModal.classList.remove("show");
      pendingLatLng = null;
    }
    btnCancel.addEventListener("click", closeAddModal);
    fType.addEventListener("change", () => renderLinkFields(fType.value));
    btnSave.addEventListener("click", async () => {
      if (!pendingLatLng) return;
      const name = fName.value.trim();
      if (!name) return alert("Name required");
      const type = fType.value;
      const links = [];
      let shabby = "", nice = "";
      if (type === "apartment") {
        shabby = document.getElementById("f-shabby").value.trim();
        nice = document.getElementById("f-nice").value.trim();
      } else if (type === "office" || type === "motel") {
        const url = document.getElementById("f-single").value.trim();
        if (url) links.push({ label:type === "office" ? "Office" : "Album", url });
      } else {
        const lbls = Array.from(addModal.querySelectorAll(".ph-label"));
        const urls = Array.from(addModal.querySelectorAll(".ph-url"));
        lbls.forEach((lbl, i) => {
          const url = urls[i]?.value.trim();
          if (url) links.push({ label: lbl.value || `Album${i+1}`, url });
        });
      }
      try {
        await addDoc(markersCol, {
          name, type, links, shabby, nice,
          x: pendingLatLng.lng, y: pendingLatLng.lat,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        closeAddModal();
        toast("Property added");
      } catch(e) {
        alert("Add error: " + e.message);
      }
    });

    function openEditModal(entry) {
      editingEntry = entry;
      const t = entry.type;
      const lks = entryLinks(entry);
      let html = `
        <div class="row"><label>Name <input id="e-name" type="text" value="${entry.name}"></label></div>
        <div class="row"><label>Type <select id="e-type">
          <option value="apartment"${t === "apartment" ? " selected" : ""}>Apartment</option>
          <option value="office"${t === "office" ? " selected" : ""}>Office</option>
          <option value="motel"${t === "motel" ? " selected" : ""}>Motel</option>
          <option value="penthouse"${t === "penthouse" ? " selected" : ""}>Penthouse</option>
        </select></label></div>
      `;
      if (t === "apartment") {
        html += `
          <div class="link-row"><label>Shabby</label><input id="e-shabby" type="url" value="${entry.shabby || ""}"></div>
          <div class="link-row"><label>Nice</label><input id="e-nice" type="url" value="${entry.nice || ""}"></div>
        `;
      } else if (t === "office" || t === "motel") {
        const url = lks[0]?.url || "";
        html += `<div class="link-row"><label>${t === "office" ? "Office" : "Album"}</label><input id="e-single" type="url" value="${url}"></div>`;
      } else {
        lks.forEach((lk, i) => {
          html += `
            <div class="grid-2">
              <input class="pe-label" data-i="${i}" type="text" value="${lk.label}">
              <input class="pe-url"   data-i="${i}" type="url"   value="${lk.url}">
            </div>
          `;
        });
      }
      html += `<div class="muted">Drag marker while in edit mode</div>`;
      editBody.innerHTML = html;
      editModal.classList.add("show");
    }
    editCancel.addEventListener("click", () => {
      editModal.classList.remove("show");
      editingEntry = null;
    });
    editSave.addEventListener("click", async () => {
      if (!editingEntry) return;
      const name = document.getElementById("e-name").value.trim();
      const type = document.getElementById("e-type").value;
      const links = [];
      let shabby = "", nice = "";
      if (type === "apartment") {
        shabby = document.getElementById("e-shabby").value.trim();
        nice = document.getElementById("e-nice").value.trim();
      } else if (type === "office" || type === "motel") {
        const url = document.getElementById("e-single").value.trim();
        if (url) links.push({ label: type === "office" ? "Office" : "Album", url });
      } else {
        const lbls = Array.from(editModal.querySelectorAll(".pe-label"));
        const urls = Array.from(editModal.querySelectorAll(".pe-url"));
        lbls.forEach((lbl, i) => {
          const url = urls[i]?.value.trim();
          if (url) links.push({ label: lbl.value || `Album${i+1}`, url });
        });
      }
      try {
        await updateDoc(doc(db, "markers", editingEntry.id), {
          name, type, links, shabby, nice,
          updatedAt: serverTimestamp()
        });
        editModal.classList.remove("show");
      } catch(e) {
        alert("Edit save failed: " + e.message);
      }
    });

    // Settings & toggles
    settingsBtn.addEventListener("click", e => {
      e.stopPropagation();
      settingsMenu.style.display = settingsMenu.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", () => { settingsMenu.style.display = "none"; });
    menuExport.addEventListener("click", () => {
      settingsMenu.style.display = "none";
      const arr = [];
      markers.forEach(r => {
        arr.push({
          name: r.entry.name,
          x: r.entry.x, y: r.entry.y,
          type: r.entry.type,
          links: r.entry.links,
          shabby: r.entry.shabby,
          nice: r.entry.nice
        });
      });
      const blob = new Blob([JSON.stringify(arr, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "markers.json";
      a.click();
      URL.revokeObjectURL(url);
    });
    menuChangelog.addEventListener("click", () => {
      settingsMenu.style.display = "none";
      if (!chgBody.innerHTML.trim()) {
        chgBody.innerHTML = CHANGELOG.map(l => `<div>${l}</div>`).join("");
      }
      chgModal.classList.add("show");
    });
    chgClose.addEventListener("click", () => chgModal.classList.remove("show"));
    chgCloseX.addEventListener("click", () => chgModal.classList.remove("show"));
    menuStats.addEventListener("click", () => {
      settingsMenu.style.display = "none";
      const counts = { total: 0, apartment: 0, penthouse: 0, office: 0, motel: 0 };
      markers.forEach(r => {
        counts.total++;
        counts[r.entry.type] = (counts[r.entry.type] || 0) + 1;
      });
      statBody.innerHTML = `
        <div style="padding:14px">
          <p><strong>Total:</strong> ${counts.total}</p>
          <p>Apt: ${counts.apartment || 0}</p>
          <p>Pen: ${counts.penthous e || 0}</p>
          <p>Office: ${counts.office || 0}</p>
          <p>Motel: ${counts.motel || 0}</p>
        </div>
      `;
      statModal.classList.add("show");
    });
    statClose.addEventListener("click", () => statModal.classList.remove("show"));
    menuToggleAreas.addEventListener("click", () => {
      settingsMenu.style.display = "none";
      if (map.hasLayer(areaLabels)) {
        map.removeLayer(areaLabels);
        toast("Areas hidden");
      } else {
        areaLabels.addTo(map);
        toast("Areas shown");
      }
    });

    unlockBtn.addEventListener("click", async () => {
      const p = prompt("Password:");
      if (p !== "D8D8D8") {
        alert("Wrong password");
        return;
      }
      if (!auth.currentUser) {
        try { await signInAnonymously(auth); } catch {}
      }
      setLockedUI(false);
    });
    lockBtn.addEventListener("click", async () => {
      try { await signOut(auth); } catch {}
      setLockedUI(true);
    });
    editModeEl.addEventListener("change", () => {
      toggleDragging();
    });

    // Start
    tryLoadImage();
  </script>
</body>
</html>
