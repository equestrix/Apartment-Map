<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    html,body{ height:100%; margin:0; background:#0fa8d2; }
    .leaflet-container{ background:#0fa8d2; }
    #map{ position:absolute; inset:56px 0 0 0; display:none; }
    #toolbar{ position:fixed; inset:0 0 auto 0; height:56px; display:flex; gap:12px; align-items:center; padding:8px 12px; background:#93c47d; color:#111; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,.2);} 
    #brand{ display:flex; align-items:center; gap:8px; }
    #brand img{ height:36px; width:auto; display:block; }
    #toolbar button{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; background:#fff; color:#111; font-weight:700; }
    #toolbar button:hover{ filter:brightness(.97); color:#111; }
    #status{ position:fixed; bottom:8px; left:10px; font:13px/1.3 system-ui; color:#111; background:rgba(255,255,255,.9); padding:4px 8px; border-radius:6px; z-index:1200; box-shadow:0 2px 6px rgba(0,0,0,.15);} 
    #version{ position:fixed; bottom:8px; right:10px; font:12px/1 monospace; color:rgba(255,255,255,.92); background:rgba(0,0,0,.6); padding:2px 6px; border-radius:4px; z-index:1200; }
    .leaflet-popup-content-wrapper{ background:#d9ead3; border:2px solid #93c47d; border-radius:10px; }
    .leaflet-popup-tip{ background:#d9ead3; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div id="brand">
      <img src="Dynasty8-GTAV-Logo.png" alt="Dynasty 8">
      <strong>Property Map</strong>
    </div>
    <button id="unlockBtn">Unlock</button>
    <button id="lockBtn" style="display:none">Lock</button>
    <span id="hint">Syncing…</span>
  </div>

  <div id="map"></div>
  <div id="status">Loading map…</div>
  <div id="version"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Build =====
    const VERSION = "beta 2.0.1";
    const VERSION_NOTE = "Map init fix; GTA static map restored; popup click guards; areas removed; overlay default ON; UI polish.";
    document.getElementById("version").textContent = VERSION;

    // ===== Firebase =====
    const firebaseConfig = { apiKey:"AIzaSyCcfOML9FD1Q5vcoCb3NdIlFKtx3LAovBc", authDomain:"dynasty8-property-map.firebaseapp.com", projectId:"dynasty8-property-map", storageBucket:"dynasty8-property-map.firebasestorage.app", messagingSenderId:"849316207524", appId:"1:849316207524:web:9c921ad842fc188d027f31" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    try { await signInAnonymously(auth); } catch(e){}
    try { await enableIndexedDbPersistence(db); } catch(e){}

    const mapEl = document.getElementById("map");
    let map, imageWidth=0, imageHeight=0, imageBounds=null;

    const MAP_CANDIDATES=["map.jpg","map.jpeg","map.png"];

    function init(imageUrl,w,h){
      imageWidth=w; imageHeight=h;
      imageBounds=L.latLngBounds([[0,0],[h,w]]);
      map=L.map("map",{ crs:L.CRS.Simple, minZoom:-2, maxZoom:5, zoomControl:false, attributionControl:false });
      L.control.zoom({position:"bottomleft"}).addTo(map);
      const imgLayer=L.imageOverlay(imageUrl,imageBounds).addTo(map);
      mapEl.style.display="block";
      requestAnimationFrame(()=>{ map.invalidateSize(); const targetZoom=map.getBoundsZoom(imageBounds,true); const center=imageBounds.getCenter(); map.setView(center,targetZoom,{animate:false}); map.panBy([0,160],{animate:false}); });
      imgLayer.once('load',()=>{ const targetZoom=map.getBoundsZoom(imageBounds,true); const center=imageBounds.getCenter(); map.setView(center,targetZoom,{animate:false}); map.panBy([0,160],{animate:false}); });
      document.getElementById("status").textContent="Image map loaded";
    }

    function tryLoadImage(i=0){
      if(i>=MAP_CANDIDATES.length){ document.getElementById("status").textContent="Could not find map image"; return; }
      const src=MAP_CANDIDATES[i]+"?v="+Date.now();
      const img=new Image();
      img.onload=()=>init(src,img.naturalWidth,img.naturalHeight);
      img.onerror=()=>tryLoadImage(i+1);
      img.src=src;
    }

    tryLoadImage();
  </script>
</body>
</html>
