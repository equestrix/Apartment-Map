<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GTA V Real Estate Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; inset: 56px 0 0 0; display:none; }
    #toolbar {
      position: fixed; inset: 0 0 auto 0; height: 56px;
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      padding: 8px 12px; background: rgba(30,30,30,0.92); color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      z-index: 1000; backdrop-filter: blur(6px);
    }
    #toolbar label { display:flex; align-items:center; gap:6px; }
    #toolbar input[type="checkbox"] { transform: translateY(1px); }
    #toolbar button {
      border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;
      background: #ffffff; color: #111; font-weight: 700;
    }
    #toolbar button:hover { filter: brightness(0.95); }
    #hint { opacity: 0.9; }
    .leaflet-tooltip { background: #111; color: #fff; border: 0; border-radius: 6px; }
    .popup h3 { margin: 0 8px 6px 0; font-size: 16px; display:inline-block; }
    .popup p { margin: 0 0 8px; }
    .popup small { color:#666; }
    #status { position: absolute; inset: 56px 0 0 0; display:grid; place-items:center; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#333; padding: 24px; text-align:center;}
    #status code { background:#eee; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div><strong>GTA V Real Estate</strong></div>

    <!-- Hidden until unlocked -->
    <label id="addWrap" style="display:none"><input type="checkbox" id="addMode"> Add marker</label>
    <label id="editWrap" style="display:none"><input type="checkbox" id="editMode"> Edit mode</label>

    <button id="unlockBtn">Unlock</button>
    <button id="lockBtn" style="display:none">Lock</button>

    <button id="syncBtn" title="Reload markers from GitHub">Sync now</button>
    <button id="exportBtn" style="display:none" title="Download markers.json">Export</button>
    <span id="hint">Loading map image…</span>
  </div>

  <div id="status">Looking for <code>map.jpg</code>, <code>map.jpeg</code>, or <code>map.png</code> in this folder…</div>
  <div id="map"></div>

  <!-- Inline fallback so file:// works; safe to leave or empty it -->
  <script id="markers" type="application/json">
  [
    {
      "name": "Sample Apartment",
      "x": 1000,
      "y": 1000,
      "shabby": "https://imgur.com/a/SHABBYEXAMPLE",
      "nice": "https://imgur.com/a/NICEEXAMPLE"
    }
  ]
  </script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ===== CONFIG =====
    const EDIT_PASSWORD = "D88"; // <-- change if needed
    const SAVE_ENDPOINT = "https://euphonious-speculoos-c7d2c2.netlify.app/.netlify/functions/save"; // Netlify function URL
    const GITHUB_MARKERS_URL = "https://equestrix.github.io/Apartment-Map/markers.json"; // Source of truth

    // ===== DOM refs =====
    const addModeEl  = document.getElementById("addMode");
    const editModeEl = document.getElementById("editMode");
    const addWrap    = document.getElementById("addWrap");
    const editWrap   = document.getElementById("editWrap");
    const exportBtn  = document.getElementById("exportBtn");
    const unlockBtn  = document.getElementById("unlockBtn");
    const lockBtn    = document.getElementById("lockBtn");
    const syncBtn    = document.getElementById("syncBtn");
    const hintEl     = document.getElementById("hint");
    const statusEl   = document.getElementById("status");
    const mapEl      = document.getElementById("map");

    // ===== State =====
    const MAP_CANDIDATES = ["map.jpg","map.jpeg","map.png"];
    const LS_KEY = "gta_map_markers_autosave_v1";
    let unlocked = false;
    let map, layerGroup;
    let markersData = []; // {name,x,y,shabby,nice,_marker}
    let currentIconSize = 32;

    // ===== Utils =====
    function toast(msg){ hintEl.textContent = msg; }
    function houseIcon(size = currentIconSize){
      return L.icon({
        iconUrl: "house.png",
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        tooltipAnchor: [0, -size/2]
      });
    }

    // Always load the live markers.json from GitHub Pages (cache-busted)
    async function loadMarkersFromGitHub() {
      const url = GITHUB_MARKERS_URL + "?v=" + Date.now();
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("markers.json fetch failed: " + res.status);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("markers.json is not an array");
        console.log("[load] from GitHub:", data);
        return data;
      } catch (err) {
        console.warn("[load] GitHub load failed:", err.message);
        // Fallback so the page still works if fetch fails
        try {
          const txt = document.getElementById("markers")?.textContent?.trim();
          return txt ? JSON.parse(txt) : [];
        } catch { return []; }
      }
    }

    function setMarkerPopup(entry){
      const html = `
        <div class="popup">
          <div style="display:flex;align-items:center;gap:8px;">
            <h3 style="margin:0">${entry.name || "Property"}</h3>
            ${ (unlocked && editModeEl.checked)
              ? '<button class="btn" data-action="edit" style="padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:#eee">Edit</button>\
                 <button class="btn" data-action="delete" style="padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:#eee">Delete</button>'
              : '' }
          </div>
          ${entry.shabby ? `<p><a href="${entry.shabby}" target="_blank" rel="noopener">Shabby Apartment</a></p>` : ""}
          ${entry.nice ? `<p><a href="${entry.nice}" target="_blank" rel="noopener">Nice Apartment</a></p>` : ""}
          <small>Coords: x=${entry.x.toFixed(1)}, y=${entry.y.toFixed(1)}</small>
        </div>`;
      entry._marker.bindPopup(html);

      entry._marker.off('popupopen').on('popupopen', (e) => {
        if (!(unlocked && editModeEl.checked)) return;
        const el = e.popup.getElement(); if (!el) return;
        const editBtn = el.querySelector('[data-action="edit"]');
        const delBtn  = el.querySelector('[data-action="delete"]');

        if (editBtn) editBtn.addEventListener('click', () => {
          const newName   = prompt("Property name:", entry.name || "") ?? entry.name;
          if (newName !== null) entry.name = newName;
          const newShabby = prompt("Shabby Apartment link (optional):", entry.shabby || "") ?? entry.shabby;
          if (newShabby !== null) entry.shabby = newShabby;
          const newNice   = prompt("Nice Apartment link (optional):", entry.nice || "") ?? entry.nice;
          if (newNice !== null) entry.nice = newNice;
          entry._marker.setTooltipContent(entry.name || "Property");
          setMarkerPopup(entry);
          entry._marker.openPopup();
          saveToGitHubAndLocal();
        });

        if (delBtn) delBtn.addEventListener('click', () => {
          if (!confirm("Delete this marker?")) return;
          layerGroup.removeLayer(entry._marker);
          const idx = markersData.indexOf(entry);
          if (idx >= 0) markersData.splice(idx, 1);
          saveToGitHubAndLocal();
        });
      });
    }

    function createMarker(entry){
      entry._marker = L.marker([entry.y, entry.x], {
        draggable: !!(unlocked && editModeEl.checked),
        autoPan: true,
        icon: houseIcon()
      })
      .addTo(layerGroup)
      .bindTooltip(entry.name || "Property", {direction: "top", offset: [0,-10]});

      setMarkerPopup(entry);

      entry._marker.on('dragend', (e) => {
        const pos = e.target.getLatLng();
        entry.y = pos.lat; entry.x = pos.lng;
        setMarkerPopup(entry);
        saveToGitHubAndLocal();
      });
    }

    function applyEditMode(){
      const canEdit = unlocked && editModeEl.checked;
      markersData.forEach(e => {
        if (e._marker) {
          if (canEdit) e._marker.dragging.enable(); else e._marker.dragging.disable();
          setMarkerPopup(e);
        }
      });
      toast(canEdit ? "Edit mode ON" : (unlocked ? "Edit mode OFF" : "Locked (view-only)"));
    }

    function setLockedUI(lock){
      unlocked = !lock;
      document.getElementById("unlockBtn").style.display = lock ? "" : "none";
      document.getElementById("lockBtn").style.display   = lock ? "none" : "";

      addWrap.style.display   = lock ? "none" : "";
      editWrap.style.display  = lock ? "none" : "";
      exportBtn.style.display = lock ? "none" : "";

      if (lock) { editModeEl.checked = false; }
      applyEditMode();
    }

    function tryLoadImage(i=0){
      if(i >= MAP_CANDIDATES.length){
        statusEl.innerHTML = 'Could not find a map image. Put it next to <code>index.html</code> and name it <code>map.jpg</code>, <code>map.jpeg</code>, or <code>map.png</code>.';
        return;
      }
      const src = MAP_CANDIDATES[i] + "?v=" + Date.now();
      const test = new Image();
      test.onload = () => init(src, test.naturalWidth, test.naturalHeight);
      test.onerror = () => tryLoadImage(i+1);
      test.src = src;
    }

    // Save helper: local safety + Netlify → GitHub (only when unlocked)
    function saveToGitHubAndLocal(){
  const clean = markersData.map(({name,x,y,shabby,nice}) => ({name,x,y,shabby,nice}));
  try { localStorage.setItem(LS_KEY, JSON.stringify(clean)); } catch {}

  if (!(unlocked && SAVE_ENDPOINT)) {
    console.log("[save] skipped (locked or no endpoint)");
    return;
  }

  console.log("[save] pushing to GitHub via Netlify…", clean);
  fetch(SAVE_ENDPOINT, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ markers: clean, author: { name: "Agent", email: "agent@example.com" } })
  })
  .then(async (r) => {
    const txt = await r.text();
    if (!r.ok) throw new Error(txt || `HTTP ${r.status}`);
    let info = {};
    try { info = JSON.parse(txt); } catch {}
    toast(`Saved to GitHub${info.commit_sha ? " (" + info.commit_sha.slice(0,7) + ")" : ""}.`);

    // Immediately reload markers from GitHub so the UI reflects exactly what's saved
    return loadMarkersFromGitHub().then((fresh) => {
      // Replace on-map data
      markersData.forEach(e => { if (e._marker) layerGroup.removeLayer(e._marker); });
      markersData = fresh;
      markersData.forEach(createMarker);
      map.fire("zoomend");
      console.log("[save] refreshed from GitHub:", info);
    });
  })
  .catch(err => {
    toast("Saved locally. (GitHub save failed)");
    console.warn("[save] FAIL:", err.message);
  });
}

    function init(imageUrl, w, h){
      statusEl.style.display = "none";
      mapEl.style.display = "block";

      const bounds = [[0,0], [h, w]];
      map = L.map("map", { crs: L.CRS.Simple, minZoom: -2, maxZoom: 5, zoomControl: true, attributionControl: false });
      L.imageOverlay(imageUrl, bounds).addTo(map);
      map.fitBounds(bounds);

      layerGroup = L.layerGroup().addTo(map);

      // Scale icons with zoom (min 16, max 48)
      map.on("zoomend", () => {
        const z = map.getZoom();
        currentIconSize = Math.max(16, Math.min(48, z * 4));
        markersData.forEach(entry => { if (entry._marker) entry._marker.setIcon(houseIcon()); });
      });

      // Load & render markers (always from GitHub)
      (async () => {
        markersData = await loadMarkersFromGitHub();
        // Clear existing layer group then render
        layerGroup.clearLayers();
        markersData.forEach(createMarker);
        map.fire("zoomend"); // initial icon-size sync
      })();

      // Add marker (only when unlocked + add mode)
      map.on("click", (e) => {
        if (!(unlocked && addModeEl.checked)) return;
        const {lat, lng} = e.latlng;
        const name   = prompt("Property name?");
        if (name === null) return;
        const shabby = prompt("Paste link for Shabby Apartment (optional):") || "";
        const nice   = prompt("Paste link for Nice Apartment (optional):") || "";
        const entry  = { name, x: lng, y: lat, shabby, nice };
        markersData.push(entry);
        createMarker(entry);
        saveToGitHubAndLocal();
      });

      // Export backup
      exportBtn.addEventListener("click", () => {
        const clean = markersData.map(({name,x,y,shabby,nice}) => ({name,x,y,shabby,nice}));
        const blob = new Blob([JSON.stringify(clean, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement("a"), { href: url, download: "markers.json" });
        document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
        toast("Exported markers.json");
      });

      // Manual sync from GitHub without reloading
      syncBtn.addEventListener("click", async () => {
        toast("Syncing from GitHub…");
        markersData.forEach(e => { if (e._marker) layerGroup.removeLayer(e._marker); });
        markersData = await loadMarkersFromGitHub();
        markersData.forEach(createMarker);
        map.fire("zoomend");
        toast("Synced.");
      });

      // Save on tab hide (best effort)
      window.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden" && unlocked && SAVE_ENDPOINT) {
          try {
            const clean = markersData.map(({name,x,y,shabby,nice}) => ({name,x,y,shabby,nice}));
            navigator.sendBeacon?.(SAVE_ENDPOINT, new Blob(
              [JSON.stringify({ markers: clean, author: { name: "Agent", email: "agent@example.com" } })],
              { type: "application/json" }
            ));
          } catch {}
        }
      });

      // Lock/Unlock controls
      setLockedUI(true); // start locked

      unlockBtn.addEventListener("click", () => {
        const p = prompt("Enter password:");
        if (p === EDIT_PASSWORD) { setLockedUI(false); toast("Edit unlocked."); }
        else { toast("Wrong password."); }
      });

      lockBtn.addEventListener("click", () => { setLockedUI(true); toast("Locked (view-only)."); });

      editModeEl.addEventListener("change", applyEditMode);
    }

    // boot
    (function tryLoadImage(i=0){
      if(i >= MAP_CANDIDATES.length){
        statusEl.innerHTML = 'Could not find a map image. Put it next to <code>index.html</code> and name it <code>map.jpg</code>, <code>map.jpeg</code>, or <code>map.png</code>.';
        return;
      }
      const src = MAP_CANDIDATES[i] + "?v=" + Date.now();
      const test = new Image();
      test.onload = () => init(src, test.naturalWidth, test.naturalHeight);
      test.onerror = () => tryLoadImage(i+1);
      test.src = src;
    })();
  </script>
</body>
</html>
